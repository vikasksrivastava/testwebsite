
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Understand about USART protocol, how to configure its clock, baud rate, and working mode. Steps to setup an USART module using HAL. Example to print messages, and get user's inputs in polling and interrupt modes." name="description"/>
<meta content="embedded systems application programming" name="keywords"/>
<meta content="vqtrong" name="author"/>
<link href="https://www.codeinsideout.com/blog/stm32/usart/" rel="canonical"/>
<link href="../../../favicon.ico" rel="icon"/>
<meta content="mkdocs-1.1.2, mkdocs-material-7.1.3" name="generator"/>
<title>Universal Synchronous Asynchronous Receiver Transmitter protocol - Code Inside Out</title>
<link href="../../../assets/stylesheets/main.e35208c4.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.ef6f36e2.min.css" rel="stylesheet"/>
<meta content="#ffffff" name="theme-color"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Noto+Serif:300,400,400i,700%7CRoboto+Mono&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font-family:"Noto Serif";--md-code-font-family:"Roboto Mono"}</style>
<link href="../../../assets/extra.css" rel="stylesheet"/>
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-42618265-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script>
<script async="" src="https://www.google-analytics.com/analytics.js"></script>
<meta content="website" property="og:type"/>
<meta content="Code Inside Out - Universal Synchronous Asynchronous Receiver Transmitter protocol" property="og:title"/>
<meta content="Understand about USART protocol, how to configure its clock, baud rate, and working mode. Steps to setup an USART module using HAL. Example to print messages, and get user's inputs in polling and interrupt modes." property="og:description"/>
<meta content="https://www.codeinsideout.com/blog/stm32/usart/" property="og:url"/>
<meta content="https://www.codeinsideout.com/assets/banner.jpg" property="og:image"/>
<meta content="image/png" property="og:image:type"/>
<meta content="1080" property="og:image:width"/>
<meta content="568" property="og:image:height"/>
</head>
<body data-md-color-accent="" data-md-color-primary="white" data-md-color-scheme="" dir="ltr">
<script>function __prefix(e){return new URL("../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#1-hardware">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="Code Inside Out" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="Code Inside Out">
<svg viewbox="0 0 640 512" xmlns="http://www.w3.org/2000/svg"><path d="m278.9 511.5-61-17.7c-6.4-1.8-10-8.5-8.2-14.9L346.2 8.7c1.8-6.4 8.5-10 14.9-8.2l61 17.7c6.4 1.8 10 8.5 8.2 14.9L293.8 503.3c-1.9 6.4-8.5 10.1-14.9 8.2zm-114-112.2 43.5-46.4c4.6-4.9 4.3-12.7-.8-17.2L117 256l90.6-79.7c5.1-4.5 5.5-12.3.8-17.2l-43.5-46.4c-4.5-4.8-12.1-5.1-17-.5L3.8 247.2c-5.1 4.7-5.1 12.8 0 17.5l144.1 135.1c4.9 4.6 12.5 4.4 17-.5zm327.2.6 144.1-135.1c5.1-4.7 5.1-12.8 0-17.5L492.1 112.1c-4.8-4.5-12.4-4.3-17 .5L431.6 159c-4.6 4.9-4.3 12.7.8 17.2L523 256l-90.6 79.7c-5.1 4.5-5.5 12.3-.8 17.2l43.5 46.4c4.5 4.9 12.1 5.1 17 .6z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Code Inside Out
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              USART
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" data-md-state="active" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</label>
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg>
</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-tabs__inner md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../..">
      Home
    </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link md-tabs__link--active" href="../../">
        Blog
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../projects/">
      Projects
    </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../tags/">
      Tags
    </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Code Inside Out" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="Code Inside Out">
<svg viewbox="0 0 640 512" xmlns="http://www.w3.org/2000/svg"><path d="m278.9 511.5-61-17.7c-6.4-1.8-10-8.5-8.2-14.9L346.2 8.7c1.8-6.4 8.5-10 14.9-8.2l61 17.7c6.4 1.8 10 8.5 8.2 14.9L293.8 503.3c-1.9 6.4-8.5 10.1-14.9 8.2zm-114-112.2 43.5-46.4c4.6-4.9 4.3-12.7-.8-17.2L117 256l90.6-79.7c5.1-4.5 5.5-12.3.8-17.2l-43.5-46.4c-4.5-4.8-12.1-5.1-17-.5L3.8 247.2c-5.1 4.7-5.1 12.8 0 17.5l144.1 135.1c4.9 4.6 12.5 4.4 17-.5zm327.2.6 144.1-135.1c5.1-4.7 5.1-12.8 0-17.5L492.1 112.1c-4.8-4.5-12.4-4.3-17 .5L431.6 159c-4.6 4.9-4.3 12.7.8 17.2L523 256l-90.6 79.7c-5.1 4.5-5.5 12.3-.8 17.2l43.5 46.4c4.5 4.9 12.1 5.1 17 .6z"></path></svg>
</a>
    Code Inside Out
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../..">
        Home
      </a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2">
        Blog
        <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Blog" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
          Blog
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../">
        Recent posts
      </a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" id="__nav_2_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_2">
        Stm32
        <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Stm32" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_2">
<span class="md-nav__icon md-icon"></span>
          Stm32
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../intro/">
        Introduction
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../toolchain/">
        Tools and Docs
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../semihosting/">
        Semihosting
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../interrupt/">
        Interrupt
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../gpio/">
        GPIO
      </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
          USART
          <span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
        USART
      </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-hardware">
    1. Hardware
  </a>
<nav aria-label="1. Hardware" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#11-wires">
    1.1. Wires
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#12-flow-control">
    1.2. Flow control
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#13-data-frame">
    1.3. Data frame
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#14-clock">
    1.4. Clock
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#15-baud-rate">
    1.5. Baud rate
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#16-multiprocessor">
    1.6. Multiprocessor
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-memory-map">
    2. Memory Map
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-register-map">
    3. Register Map
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-hal-software">
    4. HAL Software
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-lab-send-data">
    5. Lab: Send Data
  </a>
<nav aria-label="5. Lab: Send Data" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#51-create-project">
    5.1. Create project
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#52-enable-usart1">
    5.2. Enable USART1
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#53-generated-code">
    5.3. Generated code
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#54-user-code">
    5.4. User code
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#55-connect-uart-to-pc">
    5.5. Connect UART to PC
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#56-build-and-run">
    5.6. Build and Run
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#6-lab-receive-by-polling">
    6. Lab: Receive by Polling
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#7-lab-receive-by-interrupt">
    7. Lab: Receive by Interrupt
  </a>
<nav aria-label="7. Lab: Receive by Interrupt" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#71-interrupt-mode">
    7.1. Interrupt Mode
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#72-enable-interrupt">
    7.2. Enable interrupt
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#73-handler-interrupt">
    7.3. Handler interrupt
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#8-appendix">
    8. Appendix
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../timer/">
        Timer
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" id="__nav_2_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_3">
        Raspberry Pi
        <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Raspberry Pi" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_3">
<span class="md-nav__icon md-icon"></span>
          Raspberry Pi
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../pi/notes/">
        Notes
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../pi/backup_sdcard/">
        Backup SDCard
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../pi/check_camera_i2c/">
        Diagnostic Camera
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../pi/compile_ffmpeg/">
        Compile FFmpeg
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../pi/resource_usage/">
        Resource usage
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../pi/setup_camera/">
        Setup Camera
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../pi/stream_ffmpeg_hls_dash/">
        HLS/DASH Streaming
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../pi/stream_picamera_mjpeg/">
        MJPEG streaming
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../pi/stream_picamera_h264/">
        H264 streaming
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../pi/setup_headless/">
        Headless mode
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../pi/setup_wifi_ap/">
        Wifi Access Point
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../pi/save_power/">
        Save Power
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4" id="__nav_2_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_4">
        Setup blog
        <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Setup blog" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_4">
<span class="md-nav__icon md-icon"></span>
          Setup blog
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup_blog/install_and_configure/">
        Install and configure
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup_blog/markdown_syntax/">
        Markdown syntax
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup_blog/mkdocs_plugins/">
        MkDocs plugins
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup_blog/customize_theme/">
        Customize theme
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup_blog/print_to_pdf/">
        Print to PDF
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../projects/">
        Projects
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../tags/">
        Tags
      </a>
</li>
</ul>
</nav>
<div class="tag-cloud-nav">
<br/>
<br/>
<br/>
<div style="font-weight:700; font-size:.7rem; margin:0 0.6rem;">
<label>Tag cloud</label>
</div>
<div style="padding: 0.4rem 0.6rem;">
<div class="tag-cloud">
<a class="tag" href="https://www.codeinsideout.com/tags/#sdcard">
<span class="tag-name" style="font-size:0.6rem;color:DarkGreen;">sdcard
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#backup">
<span class="tag-name" style="font-size:0.6rem;color:DarkViolet;">backup
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#restore">
<span class="tag-name" style="font-size:0.6rem;color:DarkViolet;">restore
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#pi">
<span class="tag-name" style="font-size:1.5rem;color:DarkSlateGray;">pi
            </span>
<sup class="tag-count">10</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#camera">
<span class="tag-name" style="font-size:1.0rem;color:DarkOrange;">camera
            </span>
<sup class="tag-count">5</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#i2c">
<span class="tag-name" style="font-size:0.6rem;color:DarkViolet;">i2c
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#ffmpeg">
<span class="tag-name" style="font-size:0.7rem;color:DarkOrchid;">ffmpeg
            </span>
<sup class="tag-count">2</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#hardware accelerator">
<span class="tag-name" style="font-size:0.6rem;color:DarkTurquoise;">hardware accelerator
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#omx">
<span class="tag-name" style="font-size:0.6rem;color:DarkRed;">omx
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#notes">
<span class="tag-name" style="font-size:0.6rem;color:DarkRed;">notes
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#bash">
<span class="tag-name" style="font-size:0.6rem;color:DarkViolet;">bash
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#top">
<span class="tag-name" style="font-size:0.6rem;color:DarkViolet;">top
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#grep">
<span class="tag-name" style="font-size:0.6rem;color:DarkViolet;">grep
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#awk">
<span class="tag-name" style="font-size:0.6rem;color:DarkSlateGray;">awk
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#performance">
<span class="tag-name" style="font-size:0.6rem;color:DarkCyan;">performance
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#gnuplot">
<span class="tag-name" style="font-size:0.6rem;color:DarkSlateGray;">gnuplot
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#power">
<span class="tag-name" style="font-size:0.6rem;color:DarkViolet;">power
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#v4l2">
<span class="tag-name" style="font-size:0.6rem;color:DarkOrchid;">v4l2
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#python">
<span class="tag-name" style="font-size:1.0rem;color:DarkSlateGray;">python
            </span>
<sup class="tag-count">5</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#picamera">
<span class="tag-name" style="font-size:0.8rem;color:DarkTurquoise;">picamera
            </span>
<sup class="tag-count">3</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#headless">
<span class="tag-name" style="font-size:0.6rem;color:DarkOrchid;">headless
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#wifi">
<span class="tag-name" style="font-size:0.6rem;color:DarkCyan;">wifi
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#access point">
<span class="tag-name" style="font-size:0.6rem;color:DarkSlateGray;">access point
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#stream">
<span class="tag-name" style="font-size:0.8rem;color:DarkBlue;">stream
            </span>
<sup class="tag-count">3</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#hls">
<span class="tag-name" style="font-size:0.6rem;color:DarkCyan;">hls
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#dash">
<span class="tag-name" style="font-size:0.6rem;color:DarkGoldenrod;">dash
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#h264">
<span class="tag-name" style="font-size:0.6rem;color:DarkSlateGray;">h264
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#mjpeg">
<span class="tag-name" style="font-size:0.6rem;color:DarkGreen;">mjpeg
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#mkdocs">
<span class="tag-name" style="font-size:0.9rem;color:DarkBlue;">mkdocs
            </span>
<sup class="tag-count">4</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#jinja">
<span class="tag-name" style="font-size:0.6rem;color:DarkViolet;">jinja
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#markdown">
<span class="tag-name" style="font-size:0.6rem;color:DarkBlue;">markdown
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#arm">
<span class="tag-name" style="font-size:1.2rem;color:DarkSlateGray;">arm
            </span>
<sup class="tag-count">7</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#stm32">
<span class="tag-name" style="font-size:1.2rem;color:DarkSlateGray;">stm32
            </span>
<sup class="tag-count">7</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#gpio">
<span class="tag-name" style="font-size:0.6rem;color:DarkMagenta;">gpio
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#interrupt">
<span class="tag-name" style="font-size:0.6rem;color:DarkViolet;">interrupt
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#debug">
<span class="tag-name" style="font-size:0.6rem;color:DarkOrchid;">debug
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#semihosting">
<span class="tag-name" style="font-size:0.6rem;color:DarkTurquoise;">semihosting
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#clock">
<span class="tag-name" style="font-size:0.6rem;color:DarkOrchid;">clock
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#timer">
<span class="tag-name" style="font-size:0.6rem;color:DarkOliveGreen;">timer
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#toolchain">
<span class="tag-name" style="font-size:0.6rem;color:DarkRed;">toolchain
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#usart">
<span class="tag-name" style="font-size:0.6rem;color:DarkMagenta;">usart
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#uart">
<span class="tag-name" style="font-size:0.6rem;color:DarkCyan;">uart
            </span>
<sup class="tag-count">1</sup>
</a>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-hardware">
    1. Hardware
  </a>
<nav aria-label="1. Hardware" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#11-wires">
    1.1. Wires
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#12-flow-control">
    1.2. Flow control
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#13-data-frame">
    1.3. Data frame
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#14-clock">
    1.4. Clock
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#15-baud-rate">
    1.5. Baud rate
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#16-multiprocessor">
    1.6. Multiprocessor
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-memory-map">
    2. Memory Map
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-register-map">
    3. Register Map
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-hal-software">
    4. HAL Software
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-lab-send-data">
    5. Lab: Send Data
  </a>
<nav aria-label="5. Lab: Send Data" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#51-create-project">
    5.1. Create project
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#52-enable-usart1">
    5.2. Enable USART1
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#53-generated-code">
    5.3. Generated code
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#54-user-code">
    5.4. User code
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#55-connect-uart-to-pc">
    5.5. Connect UART to PC
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#56-build-and-run">
    5.6. Build and Run
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#6-lab-receive-by-polling">
    6. Lab: Receive by Polling
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#7-lab-receive-by-interrupt">
    7. Lab: Receive by Interrupt
  </a>
<nav aria-label="7. Lab: Receive by Interrupt" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#71-interrupt-mode">
    7.1. Interrupt Mode
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#72-enable-interrupt">
    7.2. Enable interrupt
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#73-handler-interrupt">
    7.3. Handler interrupt
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#8-appendix">
    8. Appendix
  </a>
</li>
</ul>
</nav>
<div class="tag-cloud-toc">
<br/>
<br/>
<br/>
<div style="font-weight:700; font-size:.7rem; margin:0 0.6rem;">
<label>Tag cloud</label>
</div>
<div style="padding: 0.4rem 0.6rem;">
<div class="tag-cloud">
<a class="tag" href="https://www.codeinsideout.com/tags/#sdcard">
<span class="tag-name" style="font-size:0.6rem;color:DarkMagenta;">sdcard
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#backup">
<span class="tag-name" style="font-size:0.6rem;color:DarkViolet;">backup
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#restore">
<span class="tag-name" style="font-size:0.6rem;color:DarkBlue;">restore
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#pi">
<span class="tag-name" style="font-size:1.5rem;color:DarkCyan;">pi
            </span>
<sup class="tag-count">10</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#camera">
<span class="tag-name" style="font-size:1.0rem;color:DarkViolet;">camera
            </span>
<sup class="tag-count">5</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#i2c">
<span class="tag-name" style="font-size:0.6rem;color:DarkOrchid;">i2c
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#ffmpeg">
<span class="tag-name" style="font-size:0.7rem;color:DarkGreen;">ffmpeg
            </span>
<sup class="tag-count">2</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#hardware accelerator">
<span class="tag-name" style="font-size:0.6rem;color:DarkOrange;">hardware accelerator
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#omx">
<span class="tag-name" style="font-size:0.6rem;color:DarkOrange;">omx
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#notes">
<span class="tag-name" style="font-size:0.6rem;color:DarkOrchid;">notes
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#bash">
<span class="tag-name" style="font-size:0.6rem;color:DarkSlateBlue;">bash
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#top">
<span class="tag-name" style="font-size:0.6rem;color:DarkRed;">top
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#grep">
<span class="tag-name" style="font-size:0.6rem;color:DarkOrange;">grep
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#awk">
<span class="tag-name" style="font-size:0.6rem;color:DarkOliveGreen;">awk
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#performance">
<span class="tag-name" style="font-size:0.6rem;color:DarkSlateGray;">performance
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#gnuplot">
<span class="tag-name" style="font-size:0.6rem;color:DarkBlue;">gnuplot
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#power">
<span class="tag-name" style="font-size:0.6rem;color:DarkMagenta;">power
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#v4l2">
<span class="tag-name" style="font-size:0.6rem;color:DarkTurquoise;">v4l2
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#python">
<span class="tag-name" style="font-size:1.0rem;color:DarkGreen;">python
            </span>
<sup class="tag-count">5</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#picamera">
<span class="tag-name" style="font-size:0.8rem;color:DarkOrange;">picamera
            </span>
<sup class="tag-count">3</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#headless">
<span class="tag-name" style="font-size:0.6rem;color:DarkTurquoise;">headless
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#wifi">
<span class="tag-name" style="font-size:0.6rem;color:DarkSlateBlue;">wifi
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#access point">
<span class="tag-name" style="font-size:0.6rem;color:DarkGreen;">access point
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#stream">
<span class="tag-name" style="font-size:0.8rem;color:DarkMagenta;">stream
            </span>
<sup class="tag-count">3</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#hls">
<span class="tag-name" style="font-size:0.6rem;color:DarkOliveGreen;">hls
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#dash">
<span class="tag-name" style="font-size:0.6rem;color:DarkMagenta;">dash
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#h264">
<span class="tag-name" style="font-size:0.6rem;color:DarkViolet;">h264
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#mjpeg">
<span class="tag-name" style="font-size:0.6rem;color:DarkBlue;">mjpeg
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#mkdocs">
<span class="tag-name" style="font-size:0.9rem;color:DarkSlateGray;">mkdocs
            </span>
<sup class="tag-count">4</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#jinja">
<span class="tag-name" style="font-size:0.6rem;color:DarkMagenta;">jinja
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#markdown">
<span class="tag-name" style="font-size:0.6rem;color:DarkSlateGray;">markdown
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#arm">
<span class="tag-name" style="font-size:1.2rem;color:DarkGreen;">arm
            </span>
<sup class="tag-count">7</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#stm32">
<span class="tag-name" style="font-size:1.2rem;color:DarkOliveGreen;">stm32
            </span>
<sup class="tag-count">7</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#gpio">
<span class="tag-name" style="font-size:0.6rem;color:DarkSlateGray;">gpio
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#interrupt">
<span class="tag-name" style="font-size:0.6rem;color:DarkGoldenrod;">interrupt
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#debug">
<span class="tag-name" style="font-size:0.6rem;color:DarkCyan;">debug
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#semihosting">
<span class="tag-name" style="font-size:0.6rem;color:DarkViolet;">semihosting
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#clock">
<span class="tag-name" style="font-size:0.6rem;color:DarkGoldenrod;">clock
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#timer">
<span class="tag-name" style="font-size:0.6rem;color:DarkOrange;">timer
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#toolchain">
<span class="tag-name" style="font-size:0.6rem;color:DarkTurquoise;">toolchain
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#usart">
<span class="tag-name" style="font-size:0.6rem;color:DarkBlue;">usart
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#uart">
<span class="tag-name" style="font-size:0.6rem;color:DarkSlateBlue;">uart
            </span>
<sup class="tag-count">1</sup>
</a>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<div class="page-cover">
<h1 class="page-title">Universal Synchronous Asynchronous Receiver Transmitter protocol</h1>
<p class="page-description">Understand about USART protocol, how to configure its clock, baud rate, and working mode. Steps to setup an USART module using HAL. Example to print messages, and get user's inputs in polling and interrupt modes.</p>
<p>
<a class="tag" href="https://www.codeinsideout.com/tags/#arm">
<span class="tag-name" style="color:DarkGreen;">
                        #arm
                    </span>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#stm32">
<span class="tag-name" style="color:DarkViolet;">
                        #stm32
                    </span>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#usart">
<span class="tag-name" style="color:DarkCyan;">
                        #usart
                    </span>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#uart">
<span class="tag-name" style="color:DarkOrchid;">
                        #uart
                    </span>
</a>
</p>
<p class="md-source-date">
<hr class="print-only"/>
<small>
                                
                                    Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">April 26, 2021</span><br/>
</small>
</p>
</div>
<div class="btn-actions screen-only"><div id="btn-download"><a class="md-button" href="..\..\..\pdfs\blog\stm32\usart\stm32__USART.pdf"><span class="twemoji"><svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M5 20h14v-2H5m14-9h-4V3H9v6H5l7 7 7-7z"></path></svg></span>PDF</a></div>
<p></p>
</div>
<div class="toc print-only">
<h2>Table of Content</h2>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-hardware">
    1. Hardware
  </a>
<nav aria-label="1. Hardware" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#11-wires">
    1.1. Wires
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#12-flow-control">
    1.2. Flow control
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#13-data-frame">
    1.3. Data frame
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#14-clock">
    1.4. Clock
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#15-baud-rate">
    1.5. Baud rate
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#16-multiprocessor">
    1.6. Multiprocessor
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-memory-map">
    2. Memory Map
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-register-map">
    3. Register Map
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-hal-software">
    4. HAL Software
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-lab-send-data">
    5. Lab: Send Data
  </a>
<nav aria-label="5. Lab: Send Data" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#51-create-project">
    5.1. Create project
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#52-enable-usart1">
    5.2. Enable USART1
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#53-generated-code">
    5.3. Generated code
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#54-user-code">
    5.4. User code
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#55-connect-uart-to-pc">
    5.5. Connect UART to PC
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#56-build-and-run">
    5.6. Build and Run
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#6-lab-receive-by-polling">
    6. Lab: Receive by Polling
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#7-lab-receive-by-interrupt">
    7. Lab: Receive by Interrupt
  </a>
<nav aria-label="7. Lab: Receive by Interrupt" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#71-interrupt-mode">
    7.1. Interrupt Mode
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#72-enable-interrupt">
    7.2. Enable interrupt
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#73-handler-interrupt">
    7.3. Handler interrupt
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#8-appendix">
    8. Appendix
  </a>
</li>
</ul>
</nav>
</div>
<h2 id="1-hardware">1. Hardware<a class="headerlink" href="#1-hardware" title="Permanent link">⚓︎</a></h2>
<p>Universal Synchronous/Asynchronous Receiver/Transmitter interface, also simply known as USART, is a device that translates a parallel sequence of bits (usually grouped in a byte) in a continuous stream of signals flowing on a single wire.</p>
<h3 id="11-wires">1.1. Wires<a class="headerlink" href="#11-wires" title="Permanent link">⚓︎</a></h3>
<p>When the information flows between two devices inside a common channel, both devices (as the sender and also the receiver) have to agree on the <em>timing</em>, that defines how long it takes to transmit each individual bit of the information. </p>
<ul>
<li>
<p>In a <em>synchronous</em> transmission, the sender and the receiver share a common clock generated by one of the two devices</p>
<p>
<figure class="w80"><img src="usart.png"/><figcaption>Shared clock in <em>synchronous</em> USART</figcaption></figure>
</p>
</li>
<li>
<p>In an <em>asynchronous</em> transmission, the clock line is omitted, and both devices have an internal clock source and a mechanism to detect start/ stop bit.</p>
<p>
<figure class="w80"><img src="uart.png"/><figcaption>One line of data in <em>asynchronous</em> USART</figcaption></figure>
</p>
</li>
</ul>
<p>In a bi-direction communication, it needs a pairs of lines for Transmitter (TX) and Receiver (RX):</p>
<p>
<figure><img src="usart_uart.png"/><figcaption>USART vs UART</figcaption>
</figure>
</p>
<h3 id="12-flow-control">1.2. Flow control<a class="headerlink" href="#12-flow-control" title="Permanent link">⚓︎</a></h3>
<p>The presence of a dedicated clock line, or a common agreement about transmission frequency, does not guarantee that the receiver of a byte stream is able to process them at the same transmission rate of the master.</p>
<p>For this reason, some communication standards, like the <em>RS232</em> and the <em>RS485</em>, provide the possibility to use a dedicated <em>Hardware Flow Control</em> line.</p>
<p>For example, two devices communicating using the RS232 interface can share two additional lines, named Request To Send(RTS) and Clear To Send(CTS): the sender sets its RTS, which signals the receiver to begin monitoring its data input line. When ready for data, the receiver will raise its complementary line, CTS, which signals the sender to start sending data, and for the sender to begin monitoring the slave’s data output line.</p>
<h3 id="13-data-frame">1.3. Data frame<a class="headerlink" href="#13-data-frame" title="Permanent link">⚓︎</a></h3>
<p>The frames are comprised of:</p>
<ul>
<li>An Idle Line prior to transmission or reception</li>
<li>A start bit</li>
<li>A data word (7, 8 or 9 bits) least significant bit first</li>
<li>0.5, 1, 1.5, 2 stop bits indicating that the frame is complete</li>
</ul>
<p>By default, the signal (TX or RX) is in low state during the start bit. It is in high state during the stop bit. These values can be inverted, separately for each signal, through polarity configuration control.</p>
<ul>
<li>An <em>Idle character</em> is interpreted as an entire frame of “1”s (the number of “1”s includes the number of stop bits).</li>
<li>A <em>Break</em> character is interpreted on receiving “0”s for a frame period. At the end of the break frame, the transmitter inserts 2 stop bits.</li>
</ul>
<p>
<figure class="w80"><img src="usart_frame.png"/><figcaption>Frames in USART</figcaption></figure>
</p>
<h3 id="14-clock">1.4. Clock<a class="headerlink" href="#14-clock" title="Permanent link">⚓︎</a></h3>
<p>The choice of the clock source is done through the Clock Control system (see Section Reset and clock control (RCC))). The clock source must be chosen before enabling the USART (by setting the UE bit).</p>
<p>Choosing LSE or HSI as clock source may allow the USART to receive data while the MCU is in low-power mode.</p>
<p>Clock source is used to do oversampling by 16 or by 8 to detect the start bit. It samples the RX line and try to detect a falling edge and following patterns of zeros.</p>
<p>
<figure class="w80"><img src="uart_detect_start.png"/><figcaption>Detect start bit using oversampling</figcaption></figure>
</p>
<h3 id="15-baud-rate">1.5. Baud rate<a class="headerlink" href="#15-baud-rate" title="Permanent link">⚓︎</a></h3>
<p>Baud rate determines the speed of transmitting and receiving, as the speed is depend on the clock source and USARTDIV value.</p>
<blockquote>
<p>USARTDIV is an unsigned fixed point number that is coded on the USART_BRR register.</p>
<ul>
<li>When OVER8 = 0, BRR = USARTDIV.</li>
<li>
<p>When OVER8 = 1</p>
<p>– BRR[2:0] = USARTDIV[3:0] shifted 1 bit to the right.</p>
<p>– BRR[3] must be kept cleared.</p>
<p>– BRR[15:4] = USARTDIV[15:4]</p>
</li>
</ul>
<p>Example: To obtain 9600 baud with fCK = 8 MHz.</p>
<ul>
<li>
<p>In case of oversampling by 16:</p>
<p>BRR = USARTDIV = 8 000 000/9600 = 833d = 0341h</p>
</li>
<li>
<p>In case of oversampling by 8:</p>
<p>USARTDIV = 2 * 8 000 000/9600 = 1666,66 (~1667d) = 683h</p>
<p>BRR[3:0] = 3h &gt;&gt; 1 = 1h</p>
<p>BRR = 0x681
</p>
</li>
</ul>
</blockquote>
<p><strong>Auto baud rate detection</strong></p>
<p>The USART is able to detect and automatically set the USART_BRR register value based on the reception of one character. Automatic baud rate detection is useful under two circumstances:</p>
<ul>
<li>The communication speed of the system is not known in advance</li>
<li>The system is using a relatively low accuracy clock source and this mechanism allows the correct baud rate to be obtained without measuring the clock deviation.</li>
</ul>
<p>Before activating the auto baud rate detection, the auto baud rate detection mode must be chosen. There are various modes based on different character patterns.</p>
<p>Prior to activating auto baud rate detection, the USART_BRR register must be initialized by writing a non-zero baud rate value.</p>
<h3 id="16-multiprocessor">1.6. Multiprocessor<a class="headerlink" href="#16-multiprocessor" title="Permanent link">⚓︎</a></h3>
<p>In multiprocessor communication, the following bits are to be kept cleared:</p>
<ul>
<li>LINEN bit in the USART_CR2 register,</li>
<li>HDSEL, IREN and SCEN bits in the USART_CR3 register.</li>
</ul>
<p>It is possible to perform multiprocessor communication with the USART (with several USARTs connected in a network). For instance one of the USARTs can be the master, its TX output connected to the RX inputs of the other USARTs. The others are slaves, their respective TX outputs are logically ANDed together and connected to the RX input of the master.</p>
<h2 id="2-memory-map">2. Memory Map<a class="headerlink" href="#2-memory-map" title="Permanent link">⚓︎</a></h2>
<p>Refer to Datasheet document of the target MCU. For example, DS8668 for STM32F051x.</p>
<h2 id="3-register-map">3. Register Map<a class="headerlink" href="#3-register-map" title="Permanent link">⚓︎</a></h2>
<p>Refer to Reference Manual document of the target MCU. For example, RM0091 for STM32F051x.</p>
<h2 id="4-hal-software">4. HAL Software<a class="headerlink" href="#4-hal-software" title="Permanent link">⚓︎</a></h2>
<p>The Hardware Abstract Layer (HAL) is designed so that it abstracts from the specific peripheral memory mapping. But, it also provides a general and more user-friendly way to configure the peripheral, without forcing the programmers to now how to configure its registers in detail.</p>
<p>ST HAL define a handler for USART ports like below:</p>
<div class="highlight"><pre><span></span><code><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">USART_TypeDef</span> <span class="o">*</span><span class="n">Instance</span><span class="p">;</span> <span class="cm">/* UART registers base address */</span>
    <span class="n">UART_InitTypeDef</span> <span class="n">Init</span><span class="p">;</span> <span class="cm">/* UART communication parameters */</span>
    <span class="n">UART_AdvFeatureInitTypeDef</span> <span class="n">AdvancedInit</span><span class="p">;</span> <span class="cm">/* UART Advanced Features initialization parameters */</span>
    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pTxBuffPtr</span><span class="p">;</span> <span class="cm">/* Pointer to UART Tx transfer Buffer */</span>
    <span class="kt">uint16_t</span> <span class="n">TxXferSize</span><span class="p">;</span> <span class="cm">/* UART Tx Transfer size */</span>
    <span class="kt">uint16_t</span> <span class="n">TxXferCount</span><span class="p">;</span> <span class="cm">/* UART Tx Transfer Counter */</span>
    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pRxBuffPtr</span><span class="p">;</span> <span class="cm">/* Pointer to UART Rx transfer Buffer */</span>
    <span class="kt">uint16_t</span> <span class="n">RxXferSize</span><span class="p">;</span> <span class="cm">/* UART Rx Transfer size */</span>
    <span class="kt">uint16_t</span> <span class="n">RxXferCount</span><span class="p">;</span> <span class="cm">/* UART Rx Transfer Counter */</span>
    <span class="n">DMA_HandleTypeDef</span> <span class="o">*</span><span class="n">hdmatx</span><span class="p">;</span> <span class="cm">/* UART Tx DMA Handle parameters */</span>
    <span class="n">DMA_HandleTypeDef</span> <span class="o">*</span><span class="n">hdmarx</span><span class="p">;</span> <span class="cm">/* UART Rx DMA Handle parameters */</span>
    <span class="n">HAL_LockTypeDef</span> <span class="n">Lock</span><span class="p">;</span> <span class="cm">/* Locking object */</span>
    <span class="n">__IO</span> <span class="n">HAL_UART_StateTypeDef</span> <span class="n">State</span><span class="p">;</span> <span class="cm">/* UART communication state */</span>
    <span class="n">__IO</span> <span class="n">HAL_UART_ErrorTypeDef</span> <span class="n">ErrorCode</span><span class="p">;</span> <span class="cm">/* UART Error code */</span>
<span class="p">}</span> <span class="n">UART_HandleTypeDef</span><span class="p">;</span>
</code></pre></div>
<blockquote>
<p>excerpt from <a href="https://www.st.com/resource/en/user_manual/dm00122015-description-of-stm32f0-hal-and-lowlayer-drivers-stmicroelectronics.pdf">Description of STM32F0 HAL and low-layer drivers</a></p>
</blockquote>
<p><strong>How to use USART HAL</strong></p>
<ol>
<li>
<p>Declare a <code>UART_HandleTypeDef</code> handle structure (eg. <code>UART_HandleTypeDef</code> huart).</p>
</li>
<li>
<p>Initialize the UART low level resources by implementing the <code>HAL_UART_MspInit()</code> API when needed:</p>
<ul>
<li>
<p>Enable the USARTx interface clock.</p>
</li>
<li>
<p>UART pins configuration:</p>
<ul>
<li>
<p>Enable the clock for the UART GPIOs.</p>
</li>
<li>
<p>Configure these UART pins as alternate function pull-up.</p>
</li>
</ul>
</li>
<li>
<p>NVIC configuration if use interrupt process (<code>HAL_UART_Transmit_IT()</code> and <code>HAL_UART_Receive_IT()</code> APIs):</p>
<ul>
<li>
<p>Configure the USARTx interrupt priority.</p>
</li>
<li>
<p>Enable the NVIC USART IRQ handle.</p>
</li>
</ul>
</li>
<li>
<p>UART interrupts handling:</p>
</li>
<li>
<p>DMA Configuration if use DMA process (<code>HAL_UART_Transmit_DMA()</code> and <code>HAL_UART_Receive_DMA()</code> APIs):</p>
<ul>
<li>
<p>Declare a DMA handle structure for the Tx/Rx channel.</p>
</li>
<li>
<p>Enable the DMAx interface clock.</p>
</li>
<li>
<p>Configure the declared DMA handle structure with the required Tx/Rx parameters.</p>
</li>
<li>
<p>Configure the DMA Tx/Rx channel.</p>
</li>
<li>
<p>Associate the initialized DMA handle to the UART DMA Tx/Rx handle.</p>
</li>
<li>
<p>Configure the priority and enable the NVIC for the transfer complete interrupt on the DMA Tx/Rx channel.</p>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Program the Baud Rate, Word Length, Stop Bit, Parity, Hardware flow control and Mode (Receiver/Transmitter) in the huart handle Init structure.</p>
</li>
<li>
<p>If required, program UART advanced features (TX/RX pins swap, auto Baud rate detection,...) in the huart handle AdvancedInit structure.</p>
</li>
<li>
<p>For the UART asynchronous mode, initialize the UART registers by calling the <code>HAL_UART_Init()</code> API.</p>
</li>
<li>
<p>For the UART Half duplex mode, initialize the UART registers by calling the <code>HAL_HalfDuplex_Init()</code> API.</p>
</li>
<li>
<p>For the UART Multiprocessor mode, initialize the UART registers by calling the <code>HAL_MultiProcessor_Init()</code> API.</p>
</li>
<li>
<p>For the UART RS485 Driver Enabled mode, initialize the UART registers by calling the <code>HAL_RS485Ex_Init()</code> API.</p>
</li>
</ol>
<h2 id="5-lab-send-data">5. Lab: Send Data<a class="headerlink" href="#5-lab-send-data" title="Permanent link">⚓︎</a></h2>
<p>This project aims to learn how to configure USART via STM32CubeIDE and STM32CubeMX.</p>
<p>Target board: STM32F0 Discovery</p>
<p>Application requirements:</p>
<ul>
<li>Enable USART1 on board</li>
<li>Transmit a log with increasing counter every 1 second</li>
</ul>
<h3 id="51-create-project">5.1. Create project<a class="headerlink" href="#51-create-project" title="Permanent link">⚓︎</a></h3>
<p>Create new project via CubeMX and use default settings for the discovery board.</p>
<div class="new-page"></div>
<h3 id="52-enable-usart1">5.2. Enable USART1<a class="headerlink" href="#52-enable-usart1" title="Permanent link">⚓︎</a></h3>
<p>Open <em>Connectivity</em> section in <em>Pinout &amp; Configs</em> tab and select USART1 module, then edit some settings:</p>
<ul>
<li>Mode: Asynchronous</li>
<li>Parameter:<ul>
<li>Baud rate: 115200 bps</li>
<li>Word length: 8 b (including Parity)</li>
<li>Parity: None</li>
<li>Stop bits: 1</li>
</ul>
</li>
</ul>
<p>
<figure class="w90"><img src="lab_enable_usart1.png"/><figcaption>Enable USART1</figcaption></figure>
</p>
<p>Note that PA9 and PA10 are automatically configured to Alternative Function to use as USART1 pinout.</p>
<h3 id="53-generated-code">5.3. Generated code<a class="headerlink" href="#53-generated-code" title="Permanent link">⚓︎</a></h3>
<p>When generate code from Pin configs, there are some noticeable code blocks:</p>
<p><strong>Peripheral instance</strong></p>
<p>IDE will add an instance handler for the USART1 module in <em>main.c</em>. This instance will be used for manage USART1 peripheral then it should be global access:</p>
<div class="highlight"><pre><span></span><code><span class="n">UART_HandleTypeDef</span> <span class="n">huart1</span><span class="p">;</span>
</code></pre></div>
<p><strong>Init functions</strong></p>
<p>The function <code>SystemClock_Config()</code> is included to setup the system clock, bus clocks. In addition, it will set the clock source for the USART1:</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span> <span class="nf">SystemClock_Config</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">RCC_OscInitTypeDef</span> <span class="n">RCC_OscInitStruct</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
  <span class="n">RCC_ClkInitTypeDef</span> <span class="n">RCC_ClkInitStruct</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="hll">  <span class="n">RCC_PeriphCLKInitTypeDef</span> <span class="n">PeriphClkInit</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span>
  <span class="cm">/** Initializes the RCC Oscillators according to the specified parameters</span>
<span class="cm">  * in the RCC_OscInitTypeDef structure.</span>
<span class="cm">  */</span>
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">OscillatorType</span> <span class="o">=</span> <span class="n">RCC_OSCILLATORTYPE_HSI</span><span class="p">;</span>
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">HSIState</span> <span class="o">=</span> <span class="n">RCC_HSI_ON</span><span class="p">;</span>
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">HSICalibrationValue</span> <span class="o">=</span> <span class="n">RCC_HSICALIBRATION_DEFAULT</span><span class="p">;</span>
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLState</span> <span class="o">=</span> <span class="n">RCC_PLL_ON</span><span class="p">;</span>
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLSource</span> <span class="o">=</span> <span class="n">RCC_PLLSOURCE_HSI</span><span class="p">;</span>
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLMUL</span> <span class="o">=</span> <span class="n">RCC_PLL_MUL12</span><span class="p">;</span>
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PREDIV</span> <span class="o">=</span> <span class="n">RCC_PREDIV_DIV1</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">HAL_RCC_OscConfig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">RCC_OscInitStruct</span><span class="p">)</span> <span class="o">!=</span> <span class="n">HAL_OK</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">Error_Handler</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="cm">/** Initializes the CPU, AHB and APB buses clocks</span>
<span class="cm">  */</span>
  <span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">ClockType</span> <span class="o">=</span> <span class="n">RCC_CLOCKTYPE_HCLK</span><span class="o">|</span><span class="n">RCC_CLOCKTYPE_SYSCLK</span>
                              <span class="o">|</span><span class="n">RCC_CLOCKTYPE_PCLK1</span><span class="p">;</span>
  <span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">SYSCLKSource</span> <span class="o">=</span> <span class="n">RCC_SYSCLKSOURCE_PLLCLK</span><span class="p">;</span>
  <span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">AHBCLKDivider</span> <span class="o">=</span> <span class="n">RCC_SYSCLK_DIV1</span><span class="p">;</span>
  <span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">APB1CLKDivider</span> <span class="o">=</span> <span class="n">RCC_HCLK_DIV1</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">HAL_RCC_ClockConfig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">RCC_ClkInitStruct</span><span class="p">,</span> <span class="n">FLASH_LATENCY_1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">HAL_OK</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">Error_Handler</span><span class="p">();</span>
  <span class="p">}</span>
<span class="hll">  <span class="n">PeriphClkInit</span><span class="p">.</span><span class="n">PeriphClockSelection</span> <span class="o">=</span> <span class="n">RCC_PERIPHCLK_USART1</span><span class="p">;</span>
</span><span class="hll">  <span class="n">PeriphClkInit</span><span class="p">.</span><span class="n">Usart1ClockSelection</span> <span class="o">=</span> <span class="n">RCC_USART1CLKSOURCE_PCLK1</span><span class="p">;</span>
</span><span class="hll">  <span class="k">if</span> <span class="p">(</span><span class="n">HAL_RCCEx_PeriphCLKConfig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">PeriphClkInit</span><span class="p">)</span> <span class="o">!=</span> <span class="n">HAL_OK</span><span class="p">)</span>
</span>  <span class="p">{</span>
    <span class="n">Error_Handler</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>The function <code>MX_USART1_UART_Init()</code> inits the USART1 instance with the values put into the init struct. This function, at the end, calls to <code>HAL_UART_Init()</code> which is an HAL function to check the init params and finally calls to <code>HAL_UART_MspInit()</code> to do low-level configs.</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span> <span class="kt">void</span> <span class="n">MX_USART1_UART_Init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">huart1</span><span class="p">.</span><span class="n">Instance</span> <span class="o">=</span> <span class="n">USART1</span><span class="p">;</span>
<span class="hll">  <span class="n">huart1</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">BaudRate</span> <span class="o">=</span> <span class="mi">115200</span><span class="p">;</span>
</span><span class="hll">  <span class="n">huart1</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">WordLength</span> <span class="o">=</span> <span class="n">UART_WORDLENGTH_8B</span><span class="p">;</span>
</span><span class="hll">  <span class="n">huart1</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">StopBits</span> <span class="o">=</span> <span class="n">UART_STOPBITS_1</span><span class="p">;</span>
</span>  <span class="n">huart1</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">Parity</span> <span class="o">=</span> <span class="n">UART_PARITY_NONE</span><span class="p">;</span>
<span class="hll">  <span class="n">huart1</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">Mode</span> <span class="o">=</span> <span class="n">UART_MODE_TX_RX</span><span class="p">;</span>
</span>  <span class="n">huart1</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">HwFlowCtl</span> <span class="o">=</span> <span class="n">UART_HWCONTROL_NONE</span><span class="p">;</span>
  <span class="n">huart1</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">OverSampling</span> <span class="o">=</span> <span class="n">UART_OVERSAMPLING_16</span><span class="p">;</span>
  <span class="n">huart1</span><span class="p">.</span><span class="n">Init</span><span class="p">.</span><span class="n">OneBitSampling</span> <span class="o">=</span> <span class="n">UART_ONE_BIT_SAMPLE_DISABLE</span><span class="p">;</span>
  <span class="n">huart1</span><span class="p">.</span><span class="n">AdvancedInit</span><span class="p">.</span><span class="n">AdvFeatureInit</span> <span class="o">=</span> <span class="n">UART_ADVFEATURE_NO_INIT</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">HAL_UART_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">HAL_OK</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">Error_Handler</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>The function <code>HAL_UART_MspInit()</code> is generated in <em>stm32f0xx_hal_msp.c</em> to override the function declared in HAL Lib. This low-level config will setup the peripheral clocks, and set alternative functions on GPIO pins.</p>
<div class="highlight"><pre><span></span><code><span class="n">oid</span> <span class="nf">HAL_UART_MspInit</span><span class="p">(</span><span class="n">UART_HandleTypeDef</span><span class="o">*</span> <span class="n">huart</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">GPIO_InitTypeDef</span> <span class="n">GPIO_InitStruct</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
  <span class="k">if</span><span class="p">(</span><span class="n">huart</span><span class="o">-&gt;</span><span class="n">Instance</span><span class="o">==</span><span class="n">USART1</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/* Peripheral clock enable */</span>
<span class="hll">    <span class="n">__HAL_RCC_USART1_CLK_ENABLE</span><span class="p">();</span>
</span><span class="hll">    <span class="n">__HAL_RCC_GPIOA_CLK_ENABLE</span><span class="p">();</span>
</span>
    <span class="cm">/**USART1 GPIO Configuration</span>
<span class="cm">    PA9     ------&gt; USART1_TX</span>
<span class="cm">    PA10     ------&gt; USART1_RX</span>
<span class="cm">    */</span>
    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Pin</span> <span class="o">=</span> <span class="n">GPIO_PIN_9</span><span class="o">|</span><span class="n">GPIO_PIN_10</span><span class="p">;</span>
<span class="hll">    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Mode</span> <span class="o">=</span> <span class="n">GPIO_MODE_AF_PP</span><span class="p">;</span>
</span>    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Pull</span> <span class="o">=</span> <span class="n">GPIO_NOPULL</span><span class="p">;</span>
<span class="hll">    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Speed</span> <span class="o">=</span> <span class="n">GPIO_SPEED_FREQ_HIGH</span><span class="p">;</span>
</span><span class="hll">    <span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Alternate</span> <span class="o">=</span> <span class="n">GPIO_AF1_USART1</span><span class="p">;</span>
</span>    <span class="n">HAL_GPIO_Init</span><span class="p">(</span><span class="n">GPIOA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">GPIO_InitStruct</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="54-user-code">5.4. User code<a class="headerlink" href="#54-user-code" title="Permanent link">⚓︎</a></h3>
<p>With generated code, just need to use <code>HAL_UART_Transmit()</code> function to send a buffer over the USART instance. Let's make a buffer, a counter, and a message every 1 second.</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="c1"> // sprintf</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="c1"> // strlen</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span> <span class="c1">// counter=xxx\n\r</span>

    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">"counter=%03d</span><span class="se">\n\r</span><span class="s">"</span><span class="p">,</span> <span class="n">counter</span><span class="o">++</span><span class="p">);</span>
<span class="hll">        <span class="n">HAL_UART_Transmit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="n">HAL_MAX_DELAY</span><span class="p">);</span>
</span>        <span class="n">HAL_Delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<p>to get the length of an array:</p>
<p><code class="highlight"><span class="cp">#define COUNTOF(__BUFFER__) (sizeof(__BUFFER__) / sizeof(*(__BUFFER__)))</span></code></p>
</blockquote>
<h3 id="55-connect-uart-to-pc">5.5. Connect UART to PC<a class="headerlink" href="#55-connect-uart-to-pc" title="Permanent link">⚓︎</a></h3>
<p>Because STM32F0 Discovery does not have a Virtual COM port on ST-LINK/V2, so use a TTL-to-USB converter.</p>
<p>Then connect pins PA9 and PA10 to UART terminal on PC. It's recommend to check the voltage because board is running at 3.3V while PC USB  or COM port is running at 5V. </p>
<blockquote>
<p>Another option is that an Arduino Uno can be used as a COM bridge if put the MCU into inactive state by connecting RESET pin to GND, and directly use both TX, RX pins which are connected to Arduino Virtual COM port.</p>
</blockquote>
<h3 id="56-build-and-run">5.6. Build and Run<a class="headerlink" href="#56-build-and-run" title="Permanent link">⚓︎</a></h3>
<p>Build and run the code on the target board, and open a COM terminal on PC to see the message from the target board. Use a digital logic analyser to see raw bits transferred in RX and TX pins.</p>
<p>
<figure><img src="lab_uart_output.png"/><figcaption>UART output on digital logic analyser</figcaption>
</figure>
</p>
<h2 id="6-lab-receive-by-polling">6. Lab: Receive by Polling<a class="headerlink" href="#6-lab-receive-by-polling" title="Permanent link">⚓︎</a></h2>
<p>Based on the Lab 1, next step is to read from UART in polling mode.</p>
<div class="admonition warning">
<p class="admonition-title">Polling mode</p>
<ul>
<li>Block the program flow</li>
<li>Have to wait for the exact number of characters</li>
</ul>
</div>
<p>Target board: STM32F0 Discovery</p>
<p>Application requirements:</p>
<ul>
<li>Read data from UART</li>
<li>If data is "stop", then do not print counter value</li>
<li>If data is "resume", then resuming printing counter value</li>
</ul>
<p>Use this function <code>HAL_UART_Receive(&amp;huart1, (uint8_t *)buffer, 6, 1000)</code>, which means:</p>
<ul>
<li>All received data is written into <em>buffer</em> (re-use it ^^)</li>
<li>Function will exit if one of the below condition meets:<ul>
<li>6 chars are received, or</li>
<li>1000 ms timeout</li>
</ul>
</li>
</ul>
<p>Let's see the modified code, with return result is checked to print the debug information.</p>
<div class="highlight"><pre><span></span><code><span class="k">const</span> <span class="kt">char</span> <span class="n">msg_ok</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\t</span><span class="s">OK</span><span class="se">\n\r</span><span class="s">"</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">msg_busy</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\t</span><span class="s">BUSY</span><span class="se">\n\r</span><span class="s">"</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">msg_error</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\t</span><span class="s">ERROR</span><span class="se">\n\r</span><span class="s">"</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">msg_timeout</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\t</span><span class="s">TIME OUT</span><span class="se">\n\r</span><span class="s">"</span><span class="p">;</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">pause</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">HAL_StatusTypeDef</span> <span class="n">ret</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pause</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">"counter=%03d</span><span class="se">\n\r</span><span class="s">"</span><span class="p">,</span> <span class="n">counter</span><span class="o">++</span><span class="p">);</span>
<span class="hll">            <span class="n">HAL_UART_Transmit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="n">HAL_MAX_DELAY</span><span class="p">);</span>
</span>        <span class="p">}</span>

<span class="hll">        <span class="n">ret</span> <span class="o">=</span> <span class="n">HAL_UART_Receive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">HAL_OK</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">HAL_UART_Transmit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span> <span class="n">msg_ok</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">msg_ok</span><span class="p">),</span> <span class="n">HAL_MAX_DELAY</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span>  <span class="n">HAL_BUSY</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">HAL_UART_Transmit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span> <span class="n">msg_busy</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">msg_busy</span><span class="p">),</span> <span class="n">HAL_MAX_DELAY</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span>  <span class="n">HAL_ERROR</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">HAL_UART_Transmit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span> <span class="n">msg_error</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">msg_error</span><span class="p">),</span> <span class="n">HAL_MAX_DELAY</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span>  <span class="n">HAL_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">HAL_UART_Transmit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span> <span class="n">msg_timeout</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">msg_timeout</span><span class="p">),</span> <span class="n">HAL_MAX_DELAY</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">"stop"</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pause</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">"resume"</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pause</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>
<p>
<figure><img src="lab_break_on_receiving.png"/><figcaption>Debug to see the received status</figcaption>
</figure>
</p>
<div class="admonition bug">
<p class="admonition-title">Bug: Uncontrollable input</p>
<p>It's hard to input correct command because the timeout behavior may break the flow, and the number of remaining characters is not predictable.</p>
</div>
<h2 id="7-lab-receive-by-interrupt">7. Lab: Receive by Interrupt<a class="headerlink" href="#7-lab-receive-by-interrupt" title="Permanent link">⚓︎</a></h2>
<h3 id="71-interrupt-mode">7.1. Interrupt Mode<a class="headerlink" href="#71-interrupt-mode" title="Permanent link">⚓︎</a></h3>
<p>Every USART peripheral provides the interrupts listed below:</p>
<table>
<thead>
<tr>
<th>Interrupt Event</th>
<th>Event Flag</th>
<th>Enable Control Bit</th>
</tr>
</thead>
<tbody>
<tr>
<td>Transmit Data Register Empty</td>
<td><code>TXE</code></td>
<td><code>TXEIE</code></td>
</tr>
<tr>
<td>Clear To Send (CTS) flag</td>
<td><code>CTS</code></td>
<td><code>CTSIE</code></td>
</tr>
<tr>
<td>Transmission Complete</td>
<td><code>TC</code></td>
<td><code>TCIE</code></td>
</tr>
<tr>
<td>Received Data Ready to be Read</td>
<td><code>RXNE</code></td>
<td><code>RXNEIE</code></td>
</tr>
<tr>
<td>Overrun Error Detected</td>
<td><code>ORE</code></td>
<td><code>RXNEIE</code></td>
</tr>
<tr>
<td>Idle Line Detected</td>
<td><code>IDLE</code></td>
<td><code>IDLEIE</code></td>
</tr>
<tr>
<td>Parity Error</td>
<td><code>PE</code></td>
<td><code>PEIE</code></td>
</tr>
<tr>
<td>Break Flag</td>
<td><code>LBD</code></td>
<td><code>LBDIE</code></td>
</tr>
<tr>
<td>Noise Flag, Overrun error and Framing Error<br/>in multi buffer communication</td>
<td><code>NF</code> or <code>ORE</code> or <code>FE</code></td>
<td><code>EIE</code></td>
</tr>
</tbody>
</table>
<p>These events generate an interrupt if the corresponding <em>Enable Control Bit</em> is set. However, STM32 MCUs are designed so that all these IRQs are bound to just one ISR for every USART peripheral. It is up to the user code to analyze the corresponding <em>Event Flag</em> to infer which interrupt has generated the request.</p>
<p>The CubeHAL is designed to automatically do this job for us. Then user is warned about the interrupt generation thanks to a series of callback functions invoked by the <code>HAL_UART_IRQHandler()</code>, which must be called inside the ISR.</p>
<p>From a technical point of view, there is not so much difference between UART transmission in polling and in interrupt mode. Both the methods transfer an array of bytes using the UART <em>Data Register</em> (DR) with the following algorithm:</p>
<ul>
<li>
<p>For data transmission, place a byte inside the <code>USART-&gt;DR</code> register and wait until the <em>Transmit Data Register Empty</em> (TXE) flag is asserted true.</p>
</li>
<li>
<p>For data reception, wait until the <em>Received Data Ready to be Read</em> (RXNE) is not asserted true, and then store the content of the <code>USART-&gt;DR</code> register inside the application memory.</p>
</li>
</ul>
<p>The difference between the two methods consists in how they wait for the completion of data transmission:</p>
<ul>
<li>
<p>In polling mode, the <code>HAL_UART_Receive()</code> / <code>HAL_UART_Transmit()</code> functions are designed so that it waits for the corresponding event flag to be set, for every byte of data.</p>
</li>
<li>
<p>In interrupt mode, the function <code>HAL_UART_Receive_IT()</code>/<code>HAL_UART_Transmit_IT()</code> are designed so that they do not wait for data transmission completion, but the dirty job to place a new byte inside the DR register, or to load its content inside the application memory, is accomplished by the ISR routine when the <code>RXNEIE</code>/<code>TXEIE</code> interrupt is generated.</p>
</li>
</ul>
<h3 id="72-enable-interrupt">7.2. Enable interrupt<a class="headerlink" href="#72-enable-interrupt" title="Permanent link">⚓︎</a></h3>
<p>Go to USART1 module, select <em>NVIC Settings</em> and enable the interrupt.</p>
<p>
<figure><img src="lab_enable_usart1_interrupt.png"/><figcaption>Enable interrupt for USART1</figcaption>
</figure>
</p>
<p>After generating code, the functions to enable interrupt are written in function <code>HAL_UART_MspInit()</code> in <em>_stm32f0xx_hal_msp.c</em> file:</p>
<div class="highlight"><pre><span></span><code><span class="n">HAL_NVIC_SetPriority</span><span class="p">(</span><span class="n">USART1_IRQn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">HAL_NVIC_EnableIRQ</span><span class="p">(</span><span class="n">USART1_IRQn</span><span class="p">);</span>
</code></pre></div>
<p>The interrupt handler is added to <em>stm32f0xx_it.c</em> file too. Trace the function <code>HAL_UART_IRQHandler()</code> to understand about how it processes the data. Basically, it checks the error, check the state, and mode of the USART instance; then it save or transfer data on RX or TX wire.</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span> <span class="nf">USART1_IRQHandler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">HAL_UART_IRQHandler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="73-handler-interrupt">7.3. Handler interrupt<a class="headerlink" href="#73-handler-interrupt" title="Permanent link">⚓︎</a></h3>
<p><strong>Send data</strong></p>
<p>Finally, use <code>HAL_UART_Transmit_IT()</code> function to send data.</p>
<div class="highlight"><pre><span></span><code><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pause</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">"counter=%03d</span><span class="se">\n\r</span><span class="s">"</span><span class="p">,</span> <span class="n">counter</span><span class="o">++</span><span class="p">);</span>
<span class="hll">        <span class="n">HAL_UART_Transmit_IT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
</span>    <span class="p">}</span>
    <span class="n">HAL_Delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Race condition in Interrupt Mode</p>
<p>Consider below code:</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span> <span class="nf">printWelcomeMessage</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">HAL_UART_Transmit_IT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span> <span class="n">buffer1</span><span class="p">,</span> <span class="n">COUNTOF</span><span class="p">(</span><span class="n">buffer1</span><span class="p">));</span>
    <span class="n">HAL_UART_Transmit_IT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span> <span class="n">buffer2</span><span class="p">,</span> <span class="n">COUNTOF</span><span class="p">(</span><span class="n">buffer2</span><span class="p">));</span>
    <span class="n">HAL_UART_Transmit_IT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span> <span class="n">buffer3</span><span class="p">,</span> <span class="n">COUNTOF</span><span class="p">(</span><span class="n">buffer3</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<p>The above code will never work correctly, since each call to the function <code>HAL_UART_Transmit_IT()</code> is much faster than the UART transmission, and the subsequent calls to the <code>HAL_UART_Transmit_IT()</code> will fail.</p>
<p>If speed is not a strict requirement for the application, and the use of the <code>HAL_UART_Transmit_IT()</code> is limited to few parts of the application, the above code could be rearranged in the following way:</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span> <span class="nf">printWelcomeMessage</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">strings</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">buffer1</span><span class="p">,</span> <span class="n">buffer2</span><span class="p">,</span> <span class="n">buffer3</span><span class="p">};</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HAL_UART_Transmit_IT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span> <span class="p">)</span><span class="n">strings</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">COUNTOF</span><span class="p">()</span><span class="n">strings</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">HAL_UART_GetState</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">)</span> <span class="o">==</span> <span class="n">HAL_UART_STATE_BUSY_TX</span> <span class="o">||</span> 
                <span class="n">HAL_UART_GetState</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">)</span> <span class="o">==</span> <span class="n">HAL_UART_STATE_BUSY_TX_RX</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>
<p><strong>Receive data</strong></p>
<p>Next step is to read data using interrupt. Because it's unknown time when a character comes, so the buffer for receiving will be filled in at anytime, even when buffer is being used in <em>sprinf()</em>, therefore, should use a new buffer to store received data, e.g. <code>cmd[]</code>.</p>
<p>When the receiver get enough characters, it will fire an interrupt, so the interrupt can be used to start handling data. HAL has a weak callback <code>HAL_UART_RxCpltCallback()</code>, so it can be overriden to turn on a flag that data is received successfully:</p>
<div class="highlight"><pre><span></span><code><span class="kt">char</span> <span class="n">rx_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="hll"><span class="kt">void</span> <span class="nf">HAL_UART_RxCpltCallback</span><span class="p">(</span><span class="n">UART_HandleTypeDef</span> <span class="o">*</span><span class="n">huart</span><span class="p">)</span>
</span><span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">huart</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">huart1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">rx_int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>In the main function, process received data only when the flag is on:</p>
<div class="highlight"><pre><span></span><code><span class="k">const</span> <span class="kt">char</span> <span class="n">msg_rx_int</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\t</span><span class="s">RX INT</span><span class="se">\n\r</span><span class="s">"</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pause</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">"counter=%03d</span><span class="se">\n\r</span><span class="s">"</span><span class="p">,</span> <span class="n">counter</span><span class="o">++</span><span class="p">);</span>
            <span class="n">HAL_UART_Transmit_IT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="n">HAL_Delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

        <span class="cm">/* use buffer may not work, because sprintf in main loop may be filling the buffer */</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">HAL_UART_Receive_IT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">HAL_OK</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">HAL_UART_Transmit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span> <span class="n">msg_ok</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">msg_ok</span><span class="p">),</span> <span class="n">HAL_MAX_DELAY</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span>  <span class="n">HAL_BUSY</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">HAL_UART_Transmit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span> <span class="n">msg_busy</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">msg_busy</span><span class="p">),</span> <span class="n">HAL_MAX_DELAY</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span>  <span class="n">HAL_ERROR</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">HAL_UART_Transmit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span> <span class="n">msg_error</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">msg_error</span><span class="p">),</span> <span class="n">HAL_MAX_DELAY</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span>  <span class="n">HAL_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">HAL_UART_Transmit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span> <span class="n">msg_timeout</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">msg_timeout</span><span class="p">),</span> <span class="n">HAL_MAX_DELAY</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">rx_int</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">rx_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">HAL_UART_Transmit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span> <span class="n">msg_rx_int</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">msg_rx_int</span><span class="p">),</span> <span class="n">HAL_MAX_DELAY</span><span class="p">);</span>
            <span class="n">HAL_UART_Transmit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">HAL_MAX_DELAY</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">"stop"</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pause</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">"resume"</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pause</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">HAL_Delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Build and run applocation code, it should work much better than the Polling version, because whenver a character is sent to the board, it will be recived correclty.</p>
<div class="admonition bug">
<p class="admonition-title">Bug: Input length is fixed</p>
<p>The above implementation has an issue: The receiving interrupt only is fired when it receives enough number of characters. In the above example, enter <em>stopxx</em> for stop command will work, but <em>stop</em> will never do.</p>
<p>To fix this, set the receive mode to get only one byte at a time, then check for the <em>newline</em> <code>\n</code> or <em>carriage return</em> <code>\r</code> character to to determine input sectences. However, this will lead to run the interrupt handler many times.</p>
</div>
<h2 id="8-appendix">8. Appendix<a class="headerlink" href="#8-appendix" title="Permanent link">⚓︎</a></h2>
<p>Windows 10 does not support PL2303 USB to Serial, but here is the fix for this problem: <a href="https://github.com/johnstevenson/pl2303-win10">https://github.com/johnstevenson/pl2303-win10</a>. This will install an old but compatible driver for EOL PL2303 chips.</p>
<h2 id="__comments">Comments</h2>
<div id="disqus_thread"></div>
<script>var disqus_config=function(){this.page.url="https://www.codeinsideout.com/blog/stm32/usart/",this.page.identifier="blog/stm32/usart/"};window.addEventListener("load",function(){var e=document,i=e.createElement("script");i.src="//vuquangtrong-github-io.disqus.com/embed.js",i.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(i)})</script>
</article>
</div>
</div>
<a class="md-top md-icon" data-md-component="top" data-md-state="hidden" href="#">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path></svg>
</a>
</main>
<footer class="md-footer">
<nav aria-label="Footer" class="md-footer__inner md-grid">
<a class="md-footer__link md-footer__link--prev" href="../gpio/" rel="prev">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</div>
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Previous
              </span>
              GPIO
            </div>
</div>
</a>
<a class="md-footer__link md-footer__link--next" href="../timer/" rel="next">
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Next
              </span>
              Timer
            </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
<div class="md-footer-copyright__highlight">
            © 2021 Code Inside Out <div style="display:none"><div>
</div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
          Material for MkDocs
        </a>
</div>
<div style="color: var(--md-footer-fg-color--lighter);">
        using
        <a href="https://github.com/vuquangtrong/mkdocs-material-blog" rel="noopener" target="_blank">
            MkDocs Material Blog
        </a>
        theme
    </div>
</div>
</div>
<div class="md-footer-social">
<a class="md-footer-social__link" href="https://github.com/vuquangtrong" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 480 512" xmlns="http://www.w3.org/2000/svg"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"></path></svg>
</a>
<a class="md-footer-social__link" href="https://facebook.com/trongvq" rel="noopener" target="_blank" title="facebook.com">
<svg viewbox="0 0 320 512" xmlns="http://www.w3.org/2000/svg"><path d="m279.14 288 14.22-92.66h-88.91v-60.13c0-25.35 12.42-50.06 52.24-50.06h40.42V6.26S260.43 0 225.36 0c-73.22 0-121.08 44.38-121.08 124.72v70.62H22.89V288h81.39v224h100.17V288z"></path></svg>
</a>
<a class="md-footer-social__link" href="https://www.linkedin.com/in/vqtrong" rel="noopener" target="_blank" title="www.linkedin.com">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.top", "header.autohide"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../../assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
<script src="../../../assets/javascripts/bundle.4ea5477f.min.js"></script>
<script src="../../../assets/extra.js"></script>
</body>
</html>