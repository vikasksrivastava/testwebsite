
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="MJPEG streaming is a simple method to get low latency. It sends JPEG images over the network and display that sequence of images on the user webpage. However, it consumes much more bandwidth. A server can be easily made by Picamera and Python HTTP." name="description"/>
<meta content="embedded systems application programming" name="keywords"/>
<meta content="vqtrong" name="author"/>
<link href="https://www.codeinsideout.com/blog/pi/stream_picamera_mjpeg/" rel="canonical"/>
<link href="../../../favicon.ico" rel="icon"/>
<meta content="mkdocs-1.1.2, mkdocs-material-7.1.3" name="generator"/>
<title>Camera live streaming using MJPEG format - Code Inside Out</title>
<link href="../../../assets/stylesheets/main.e35208c4.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.ef6f36e2.min.css" rel="stylesheet"/>
<meta content="#ffffff" name="theme-color"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Noto+Serif:300,400,400i,700%7CRoboto+Mono&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font-family:"Noto Serif";--md-code-font-family:"Roboto Mono"}</style>
<link href="../../../assets/extra.css" rel="stylesheet"/>
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-42618265-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script>
<script async="" src="https://www.google-analytics.com/analytics.js"></script>
<meta content="website" property="og:type"/>
<meta content="Code Inside Out - Camera live streaming using MJPEG format" property="og:title"/>
<meta content="MJPEG streaming is a simple method to get low latency. It sends JPEG images over the network and display that sequence of images on the user webpage. However, it consumes much more bandwidth. A server can be easily made by Picamera and Python HTTP." property="og:description"/>
<meta content="https://www.codeinsideout.com/blog/pi/stream_picamera_mjpeg/" property="og:url"/>
<meta content="https://www.codeinsideout.com/blog/pi/stream_picamera_mjpeg/MJPG_BigBuckBunny_snapshot.jpg" property="og:image"/>
<meta content="image/png" property="og:image:type"/>
<meta content="1080" property="og:image:width"/>
<meta content="568" property="og:image:height"/>
</head>
<body data-md-color-accent="" data-md-color-primary="white" data-md-color-scheme="" dir="ltr">
<script>function __prefix(e){return new URL("../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#1-record-video-to-a-stream">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="Code Inside Out" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="Code Inside Out">
<svg viewbox="0 0 640 512" xmlns="http://www.w3.org/2000/svg"><path d="m278.9 511.5-61-17.7c-6.4-1.8-10-8.5-8.2-14.9L346.2 8.7c1.8-6.4 8.5-10 14.9-8.2l61 17.7c6.4 1.8 10 8.5 8.2 14.9L293.8 503.3c-1.9 6.4-8.5 10.1-14.9 8.2zm-114-112.2 43.5-46.4c4.6-4.9 4.3-12.7-.8-17.2L117 256l90.6-79.7c5.1-4.5 5.5-12.3.8-17.2l-43.5-46.4c-4.5-4.8-12.1-5.1-17-.5L3.8 247.2c-5.1 4.7-5.1 12.8 0 17.5l144.1 135.1c4.9 4.6 12.5 4.4 17-.5zm327.2.6 144.1-135.1c5.1-4.7 5.1-12.8 0-17.5L492.1 112.1c-4.8-4.5-12.4-4.3-17 .5L431.6 159c-4.6 4.9-4.3 12.7.8 17.2L523 256l-90.6 79.7c-5.1 4.5-5.5 12.3-.8 17.2l43.5 46.4c4.5 4.9 12.1 5.1 17 .6z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Code Inside Out
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              MJPEG streaming
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" data-md-state="active" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</label>
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg>
</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-tabs__inner md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../..">
      Home
    </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link md-tabs__link--active" href="../../">
        Blog
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../projects/">
      Projects
    </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../tags/">
      Tags
    </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Code Inside Out" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="Code Inside Out">
<svg viewbox="0 0 640 512" xmlns="http://www.w3.org/2000/svg"><path d="m278.9 511.5-61-17.7c-6.4-1.8-10-8.5-8.2-14.9L346.2 8.7c1.8-6.4 8.5-10 14.9-8.2l61 17.7c6.4 1.8 10 8.5 8.2 14.9L293.8 503.3c-1.9 6.4-8.5 10.1-14.9 8.2zm-114-112.2 43.5-46.4c4.6-4.9 4.3-12.7-.8-17.2L117 256l90.6-79.7c5.1-4.5 5.5-12.3.8-17.2l-43.5-46.4c-4.5-4.8-12.1-5.1-17-.5L3.8 247.2c-5.1 4.7-5.1 12.8 0 17.5l144.1 135.1c4.9 4.6 12.5 4.4 17-.5zm327.2.6 144.1-135.1c5.1-4.7 5.1-12.8 0-17.5L492.1 112.1c-4.8-4.5-12.4-4.3-17 .5L431.6 159c-4.6 4.9-4.3 12.7.8 17.2L523 256l-90.6 79.7c-5.1 4.5-5.5 12.3-.8 17.2l43.5 46.4c4.5 4.9 12.1 5.1 17 .6z"></path></svg>
</a>
    Code Inside Out
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../..">
        Home
      </a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2">
        Blog
        <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Blog" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
          Blog
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../">
        Recent posts
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" id="__nav_2_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_2">
        Stm32
        <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Stm32" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_2">
<span class="md-nav__icon md-icon"></span>
          Stm32
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../stm32/intro/">
        Introduction
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../stm32/toolchain/">
        Tools and Docs
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../stm32/semihosting/">
        Semihosting
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../stm32/interrupt/">
        Interrupt
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../stm32/clock/">
        Clock
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../stm32/gpio/">
        GPIO
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../stm32/usart/">
        USART
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../stm32/uart_redirection/">
        UART Redirection
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../stm32/notes/">
        Notes
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" id="__nav_2_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_3">
        Raspberry Pi
        <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Raspberry Pi" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_3">
<span class="md-nav__icon md-icon"></span>
          Raspberry Pi
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../notes/">
        Notes
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../backup_sdcard/">
        Backup SDCard
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../check_camera_i2c/">
        Diagnostic Camera
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../compile_ffmpeg/">
        Compile FFmpeg
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../resource_usage/">
        Resource usage
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../setup_camera/">
        Setup Camera
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../stream_ffmpeg_hls_dash/">
        HLS/DASH Streaming
      </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
          MJPEG streaming
          <span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
        MJPEG streaming
      </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-record-video-to-a-stream">
    1. Record video to a stream
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-frame-buffer">
    2. Frame buffer
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-streaming-web-server">
    3. Streaming Web server
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-request-handler">
    4. Request Handler
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-synchronize-between-threads">
    5. Synchronize between threads
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#6-some-updates-in-the-script">
    6. Some updates in the script
  </a>
<nav aria-label="6. Some updates in the script" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#61-class-variable">
    6.1. Class variable
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#62-instance-variable">
    6.2. Instance variable
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#63-args-and-kwargs">
    6.3. *args and **kwargs
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#64-lambda-function">
    6.4. Lambda function
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#65-measure-fps">
    6.5. Measure FPS
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../stream_picamera_h264/">
        H264 streaming
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../setup_headless/">
        Headless mode
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../setup_wifi_ap/">
        Wifi Access Point
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../save_power/">
        Save Power
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4" id="__nav_2_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_2_4">
        Setup blog
        <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Setup blog" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_4">
<span class="md-nav__icon md-icon"></span>
          Setup blog
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup_blog/install_and_configure/">
        Install and configure
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup_blog/markdown_syntax/">
        Markdown syntax
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup_blog/mkdocs_plugins/">
        MkDocs plugins
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup_blog/customize_theme/">
        Customize theme
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../setup_blog/print_to_pdf/">
        Print to PDF
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../projects/">
        Projects
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../tags/">
        Tags
      </a>
</li>
</ul>
</nav>
<div class="tag-cloud-nav">
<br/>
<br/>
<br/>
<div style="font-weight:700; font-size:.7rem; margin:0 0.6rem;">
<label>Tag cloud</label>
</div>
<div style="padding: 0.4rem 0.6rem;">
<div class="tag-cloud">
<a class="tag" href="https://www.codeinsideout.com/tags/#headless">
<span class="tag-name" style="font-size:0.6rem;color:DarkMagenta;">headless
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#semihosting">
<span class="tag-name" style="font-size:0.6rem;color:DarkMagenta;">semihosting
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#i2c">
<span class="tag-name" style="font-size:0.6rem;color:DarkGoldenrod;">i2c
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#stm32">
<span class="tag-name" style="font-size:1.4rem;color:DarkSlateBlue;">stm32
            </span>
<sup class="tag-count">9</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#camera">
<span class="tag-name" style="font-size:1.0rem;color:DarkCyan;">camera
            </span>
<sup class="tag-count">5</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#pi">
<span class="tag-name" style="font-size:1.5rem;color:DarkSlateGray;">pi
            </span>
<sup class="tag-count">10</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#mjpeg">
<span class="tag-name" style="font-size:0.6rem;color:DarkSlateBlue;">mjpeg
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#top">
<span class="tag-name" style="font-size:0.6rem;color:DarkOrange;">top
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#redirect">
<span class="tag-name" style="font-size:0.6rem;color:DarkRed;">redirect
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#toolchain">
<span class="tag-name" style="font-size:0.6rem;color:DarkRed;">toolchain
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#python">
<span class="tag-name" style="font-size:1.0rem;color:DarkGreen;">python
            </span>
<sup class="tag-count">5</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#stream">
<span class="tag-name" style="font-size:0.8rem;color:DarkGreen;">stream
            </span>
<sup class="tag-count">3</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#restore">
<span class="tag-name" style="font-size:0.6rem;color:DarkSlateBlue;">restore
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#bash">
<span class="tag-name" style="font-size:0.6rem;color:DarkViolet;">bash
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#omx">
<span class="tag-name" style="font-size:0.6rem;color:DarkCyan;">omx
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#hardware accelerator">
<span class="tag-name" style="font-size:0.6rem;color:DarkOrchid;">hardware accelerator
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#gpio">
<span class="tag-name" style="font-size:0.6rem;color:DarkGreen;">gpio
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#uart">
<span class="tag-name" style="font-size:0.7rem;color:DarkOrange;">uart
            </span>
<sup class="tag-count">2</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#markdown">
<span class="tag-name" style="font-size:0.6rem;color:DarkTurquoise;">markdown
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#notes">
<span class="tag-name" style="font-size:0.8rem;color:DarkGoldenrod;">notes
            </span>
<sup class="tag-count">3</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#jinja">
<span class="tag-name" style="font-size:0.6rem;color:DarkRed;">jinja
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#c">
<span class="tag-name" style="font-size:0.6rem;color:DarkSlateGray;">c
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#picamera">
<span class="tag-name" style="font-size:0.8rem;color:DarkTurquoise;">picamera
            </span>
<sup class="tag-count">3</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#power">
<span class="tag-name" style="font-size:0.6rem;color:DarkBlue;">power
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#access point">
<span class="tag-name" style="font-size:0.6rem;color:DarkMagenta;">access point
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#grep">
<span class="tag-name" style="font-size:0.6rem;color:DarkSlateGray;">grep
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#awk">
<span class="tag-name" style="font-size:0.6rem;color:DarkTurquoise;">awk
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#wifi">
<span class="tag-name" style="font-size:0.6rem;color:DarkCyan;">wifi
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#h264">
<span class="tag-name" style="font-size:0.6rem;color:DarkGoldenrod;">h264
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#sdcard">
<span class="tag-name" style="font-size:0.6rem;color:DarkCyan;">sdcard
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#performance">
<span class="tag-name" style="font-size:0.6rem;color:DarkBlue;">performance
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#c++">
<span class="tag-name" style="font-size:0.6rem;color:DarkOliveGreen;">c++
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#usart">
<span class="tag-name" style="font-size:0.6rem;color:DarkCyan;">usart
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#interrupt">
<span class="tag-name" style="font-size:0.6rem;color:DarkCyan;">interrupt
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#gnuplot">
<span class="tag-name" style="font-size:0.6rem;color:DarkBlue;">gnuplot
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#arm">
<span class="tag-name" style="font-size:1.4rem;color:DarkOrange;">arm
            </span>
<sup class="tag-count">9</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#v4l2">
<span class="tag-name" style="font-size:0.6rem;color:DarkGreen;">v4l2
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#backup">
<span class="tag-name" style="font-size:0.6rem;color:DarkGoldenrod;">backup
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#clock">
<span class="tag-name" style="font-size:0.6rem;color:DarkSlateBlue;">clock
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#mkdocs">
<span class="tag-name" style="font-size:0.9rem;color:DarkOliveGreen;">mkdocs
            </span>
<sup class="tag-count">4</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#debug">
<span class="tag-name" style="font-size:0.6rem;color:DarkCyan;">debug
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#ffmpeg">
<span class="tag-name" style="font-size:0.7rem;color:DarkOliveGreen;">ffmpeg
            </span>
<sup class="tag-count">2</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#hls">
<span class="tag-name" style="font-size:0.6rem;color:DarkGreen;">hls
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#dash">
<span class="tag-name" style="font-size:0.6rem;color:DarkMagenta;">dash
            </span>
<sup class="tag-count">1</sup>
</a>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-record-video-to-a-stream">
    1. Record video to a stream
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-frame-buffer">
    2. Frame buffer
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-streaming-web-server">
    3. Streaming Web server
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-request-handler">
    4. Request Handler
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-synchronize-between-threads">
    5. Synchronize between threads
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#6-some-updates-in-the-script">
    6. Some updates in the script
  </a>
<nav aria-label="6. Some updates in the script" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#61-class-variable">
    6.1. Class variable
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#62-instance-variable">
    6.2. Instance variable
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#63-args-and-kwargs">
    6.3. *args and **kwargs
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#64-lambda-function">
    6.4. Lambda function
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#65-measure-fps">
    6.5. Measure FPS
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
<div class="tag-cloud-toc">
<br/>
<br/>
<br/>
<div style="font-weight:700; font-size:.7rem; margin:0 0.6rem;">
<label>Tag cloud</label>
</div>
<div style="padding: 0.4rem 0.6rem;">
<div class="tag-cloud">
<a class="tag" href="https://www.codeinsideout.com/tags/#jinja">
<span class="tag-name" style="font-size:0.6rem;color:DarkMagenta;">jinja
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#hardware accelerator">
<span class="tag-name" style="font-size:0.6rem;color:DarkSlateBlue;">hardware accelerator
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#uart">
<span class="tag-name" style="font-size:0.7rem;color:DarkTurquoise;">uart
            </span>
<sup class="tag-count">2</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#notes">
<span class="tag-name" style="font-size:0.8rem;color:DarkSlateGray;">notes
            </span>
<sup class="tag-count">3</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#usart">
<span class="tag-name" style="font-size:0.6rem;color:DarkOliveGreen;">usart
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#picamera">
<span class="tag-name" style="font-size:0.8rem;color:DarkMagenta;">picamera
            </span>
<sup class="tag-count">3</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#omx">
<span class="tag-name" style="font-size:0.6rem;color:DarkBlue;">omx
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#c++">
<span class="tag-name" style="font-size:0.6rem;color:DarkGoldenrod;">c++
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#h264">
<span class="tag-name" style="font-size:0.6rem;color:DarkTurquoise;">h264
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#gpio">
<span class="tag-name" style="font-size:0.6rem;color:DarkOliveGreen;">gpio
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#interrupt">
<span class="tag-name" style="font-size:0.6rem;color:DarkOrange;">interrupt
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#awk">
<span class="tag-name" style="font-size:0.6rem;color:DarkCyan;">awk
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#bash">
<span class="tag-name" style="font-size:0.6rem;color:DarkSlateBlue;">bash
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#camera">
<span class="tag-name" style="font-size:1.0rem;color:DarkBlue;">camera
            </span>
<sup class="tag-count">5</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#wifi">
<span class="tag-name" style="font-size:0.6rem;color:DarkSlateGray;">wifi
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#mjpeg">
<span class="tag-name" style="font-size:0.6rem;color:DarkBlue;">mjpeg
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#pi">
<span class="tag-name" style="font-size:1.5rem;color:DarkSlateGray;">pi
            </span>
<sup class="tag-count">10</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#debug">
<span class="tag-name" style="font-size:0.6rem;color:DarkBlue;">debug
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#sdcard">
<span class="tag-name" style="font-size:0.6rem;color:DarkGoldenrod;">sdcard
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#i2c">
<span class="tag-name" style="font-size:0.6rem;color:DarkGreen;">i2c
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#mkdocs">
<span class="tag-name" style="font-size:0.9rem;color:DarkOliveGreen;">mkdocs
            </span>
<sup class="tag-count">4</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#redirect">
<span class="tag-name" style="font-size:0.6rem;color:DarkSlateGray;">redirect
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#gnuplot">
<span class="tag-name" style="font-size:0.6rem;color:DarkOrchid;">gnuplot
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#restore">
<span class="tag-name" style="font-size:0.6rem;color:DarkSlateBlue;">restore
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#stm32">
<span class="tag-name" style="font-size:1.4rem;color:DarkOrchid;">stm32
            </span>
<sup class="tag-count">9</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#hls">
<span class="tag-name" style="font-size:0.6rem;color:DarkSlateGray;">hls
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#python">
<span class="tag-name" style="font-size:1.0rem;color:DarkSlateGray;">python
            </span>
<sup class="tag-count">5</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#clock">
<span class="tag-name" style="font-size:0.6rem;color:DarkOliveGreen;">clock
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#ffmpeg">
<span class="tag-name" style="font-size:0.7rem;color:DarkMagenta;">ffmpeg
            </span>
<sup class="tag-count">2</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#power">
<span class="tag-name" style="font-size:0.6rem;color:DarkTurquoise;">power
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#performance">
<span class="tag-name" style="font-size:0.6rem;color:DarkGoldenrod;">performance
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#grep">
<span class="tag-name" style="font-size:0.6rem;color:DarkGoldenrod;">grep
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#stream">
<span class="tag-name" style="font-size:0.8rem;color:DarkRed;">stream
            </span>
<sup class="tag-count">3</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#arm">
<span class="tag-name" style="font-size:1.4rem;color:DarkRed;">arm
            </span>
<sup class="tag-count">9</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#dash">
<span class="tag-name" style="font-size:0.6rem;color:DarkViolet;">dash
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#toolchain">
<span class="tag-name" style="font-size:0.6rem;color:DarkOliveGreen;">toolchain
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#top">
<span class="tag-name" style="font-size:0.6rem;color:DarkGreen;">top
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#backup">
<span class="tag-name" style="font-size:0.6rem;color:DarkRed;">backup
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#semihosting">
<span class="tag-name" style="font-size:0.6rem;color:DarkOrange;">semihosting
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#headless">
<span class="tag-name" style="font-size:0.6rem;color:DarkOliveGreen;">headless
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#markdown">
<span class="tag-name" style="font-size:0.6rem;color:DarkSlateGray;">markdown
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#c">
<span class="tag-name" style="font-size:0.6rem;color:DarkGoldenrod;">c
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#v4l2">
<span class="tag-name" style="font-size:0.6rem;color:DarkSlateBlue;">v4l2
            </span>
<sup class="tag-count">1</sup>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#access point">
<span class="tag-name" style="font-size:0.6rem;color:DarkRed;">access point
            </span>
<sup class="tag-count">1</sup>
</a>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<div class="page-cover">
<h1 class="page-title">Camera live streaming using MJPEG format</h1>
<p class="page-description">MJPEG streaming is a simple method to get low latency. It sends JPEG images over the network and display that sequence of images on the user webpage. However, it consumes much more bandwidth. A server can be easily made by Picamera and Python HTTP.</p>
<p>
<a class="tag" href="https://www.codeinsideout.com/tags/#pi">
<span class="tag-name" style="color:DarkSlateBlue;">
                        #pi
                    </span>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#stream">
<span class="tag-name" style="color:DarkOrange;">
                        #stream
                    </span>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#camera">
<span class="tag-name" style="color:DarkSlateGray;">
                        #camera
                    </span>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#mjpeg">
<span class="tag-name" style="color:DarkOliveGreen;">
                        #mjpeg
                    </span>
</a>
<a class="tag" href="https://www.codeinsideout.com/tags/#picamera">
<span class="tag-name" style="color:DarkOliveGreen;">
                        #picamera
                    </span>
</a>
</p>
<p class="md-source-date">
<hr class="print-only"/>
<small>
                                
                                    Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">April 23, 2021</span><br/>
</small>
</p>
</div>
<div class="toc print-only">
<h2>Table of Content</h2>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-record-video-to-a-stream">
    1. Record video to a stream
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-frame-buffer">
    2. Frame buffer
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-streaming-web-server">
    3. Streaming Web server
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#4-request-handler">
    4. Request Handler
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#5-synchronize-between-threads">
    5. Synchronize between threads
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#6-some-updates-in-the-script">
    6. Some updates in the script
  </a>
<nav aria-label="6. Some updates in the script" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#61-class-variable">
    6.1. Class variable
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#62-instance-variable">
    6.2. Instance variable
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#63-args-and-kwargs">
    6.3. *args and **kwargs
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#64-lambda-function">
    6.4. Lambda function
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#65-measure-fps">
    6.5. Measure FPS
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div><div class="btn-actions screen-only"><p><a class="md-button" href="..\..\..\pdfs\blog\pi\stream_picamera_mjpeg\pi__MJPEG_streaming.pdf"><span class="twemoji"><svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M5 20h14v-2H5m14-9h-4V3H9v6H5l7 7 7-7z"></path></svg></span>PDF</a></p></div>
<div class="screen-only">
<video autoplay="autoplay" loop="loop" style="width:100%">
<source src="MJPG_BigBuckBunny.mp4" type="video/mp4"/>
</video>
<figure>
<figcaption>Low latency streaming using MJPEG format</figcaption>
</figure>
<blockquote>
<p>Big Buck Bunny movie, © 2008, Blender Foundation / www.bigbuckbunny.org</p>
</blockquote>
<!--
[:material-download: Download stream_picamera_mjpeg.zip](stream_picamera_mjpeg.zip){.md-button}
-->
<p><a class="md-button" href="https://github.com/vuquangtrong/pi_streaming"><span class="twemoji"><svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M5 20h14v-2H5m14-9h-4V3H9v6H5l7 7 7-7z"></path></svg></span> Download stream_picamera_mjpeg</a></p>
</div>
<div class="print-only">
<p>
<figure><img src="stream_picamera_mjpeg.png"/><figcaption>A low latency in MJPEG streaming</figcaption>
</figure>
</p>
<blockquote>
<p>Source code available at <a href="https://github.com/vuquangtrong/pi_streaming">https://github.com/vuquangtrong/pi_streaming</a></p>
</blockquote>
</div>
<p>There are many choices to start streaming with MJPEG (MJPG) format. The basic method is to send a series of JPEG (JPG) image to the user's webpage and display it in an <code>&lt;img&gt;</code> tag. An example of streaming server is <a href="https://github.com/jacksonliam/mjpg-streamer">mjpg-streamer</a>.</p>
<p>This post shows a method to develop a streaming system, starting with a Python package named <a href="https://picamera.readthedocs.io/en/latest/">picamera</a>.</p>
<div class="admonition info">
<p class="admonition-title">Setup PiCamera</p>
<p>To setup <code>picamera</code>, please see more in <a href="../setup_camera/#install-picamera">Setup Camera</a></p>
<p>Picamera has an example to stream MJPEG at <a href="https://picamera.readthedocs.io/en/latest/recipes2.html#web-streaming">Web streaming</a> section. Just copy and run their code to see how it works.</p>
</div>
<p>The basic structure of this streaming server is as below:</p>
<div class="mermaid">graph LR
    subgraph RPi
        subgraph Server
            i[index.html] --&gt; h[HTTPServer]
        end
        Camera --&gt; Picamera --&gt; FrameBuffer --&gt; h
    end

    subgraph User[User's webpage]
        h --&gt; w[Web View]
    end
</div>
<h2 id="1-record-video-to-a-stream">1. Record video to a stream<a class="headerlink" href="#1-record-video-to-a-stream" title="Permanent link">⚓︎</a></h2>
<p>This is a basic step to write a video stream to a buffered memory. Python has <code>io</code> package which provides binary I/O which expects bytes-like objects and produces <code>bytes</code> objects. No encoding, decoding, or newline translation is performed.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">picamera</span> <span class="kn">import</span> <span class="n">PiCamera</span>

<span class="c1"># create in-memory stream</span>
<span class="n">stream</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>

<span class="c1"># create camera object (instance)</span>
<span class="n">camera</span> <span class="o">=</span> <span class="n">PiCamera</span><span class="p">()</span>
<span class="c1"># config camera</span>
<span class="n">camera</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="p">(</span><span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">)</span>
<span class="c1"># start recording to stream</span>
<span class="n">camera</span><span class="o">.</span><span class="n">start_recording</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">'h264'</span><span class="p">,</span> <span class="n">quality</span><span class="o">=</span><span class="mi">23</span><span class="p">)</span>
<span class="c1"># wait</span>
<span class="n">camera</span><span class="o">.</span><span class="n">wait_recording</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="c1"># stop recording</span>
<span class="n">camera</span><span class="o">.</span><span class="n">stop_recording</span><span class="p">()</span>
</code></pre></div>
<p>That's very easy.</p>
<h2 id="2-frame-buffer">2. Frame buffer<a class="headerlink" href="#2-frame-buffer" title="Permanent link">⚓︎</a></h2>
<p>Next step is to create a custom output to used in <code>PiCamera.start_recording()</code> method. Refer to <a href="https://picamera.readthedocs.io/en/latest/recipes2.html#custom-outputs">Custom outputs</a>:</p>
<p>A file-like object (as far as picamera is concerned) is simply an object with:</p>
<ul>
<li>a <code>write(b)</code> method which must accept a single parameter consisting of a byte-string, and which can optionally return the number of bytes written.</li>
<li>a <code>flush()</code> method with no parameters, which will be called at the end of output.</li>
</ul>
<blockquote>
<p>In <code>write</code> method, it can implement code that reacts to each and every frame. <code>write</code> method is called so frequently, its implementation must be sufficiently rapid that it doesn’t stall the encoder.</p>
</blockquote>
<p>Let's write a class <code>FrameBuffer()</code> like below:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">io</span>

<span class="k">class</span> <span class="nc">FrameBuffer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># store each frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># buffer to hold incoming frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
        <span class="c1"># if it's a JPEG image</span>
        <span class="k">if</span> <span class="n">buf</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s1">'</span><span class="se">\xff\xd8</span><span class="s1">'</span><span class="p">):</span>
            <span class="c1"># write to buffer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
            <span class="c1"># extract frame</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">truncate</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</code></pre></div>
<div class="admonition info notitle">
<p class="admonition-title"> </p>
<p>Note that <code>FrameBuffer.frame</code> will be used to send the frame to user's webpage.</p>
</div>
<p>Then, use the FrameBuffer instead of the buffered memory:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># create buffer</span>
<span class="n">frame_buffer</span> <span class="o">=</span> <span class="n">FrameBuffer</span><span class="p">()</span>

<span class="c1"># write to framebuffer</span>
<span class="n">camera</span><span class="o">.</span><span class="n">start_recording</span><span class="p">(</span><span class="n">frame_buffer</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">'mjpeg'</span><span class="p">)</span>
</code></pre></div>
<h2 id="3-streaming-web-server">3. Streaming Web server<a class="headerlink" href="#3-streaming-web-server" title="Permanent link">⚓︎</a></h2>
<p>Python has built-in a simple HTTP Server, which is ready to run by providing a server address and a request handler class.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">http.server</span> <span class="kn">import</span> <span class="n">HTTPServer</span><span class="p">,</span> <span class="n">BaseHTTPRequestHandler</span>

<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">server_class</span><span class="o">=</span><span class="n">HTTPServer</span><span class="p">,</span> <span class="n">handler_class</span><span class="o">=</span><span class="n">BaseHTTPRequestHandler</span><span class="p">):</span>
    <span class="n">server_address</span> <span class="o">=</span> <span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="mi">8000</span><span class="p">)</span>
    <span class="n">httpd</span> <span class="o">=</span> <span class="n">server_class</span><span class="p">(</span><span class="n">server_address</span><span class="p">,</span> <span class="n">handler_class</span><span class="p">)</span>
    <span class="n">httpd</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div>
<p>Now, look at some pre-defined Request Handler classes:</p>
<dl>
<dt><strong><code class="highlight"><span class="k">class</span> <span class="nc">http</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">BaseHTTPRequestHandler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">client_address</span><span class="p">,</span> <span class="n">server</span><span class="p">)</span></code></strong></dt>
<dd>This class is used to handle the HTTP requests that arrive at the server. By itself, it cannot respond to any actual HTTP requests; it must be subclassed to handle each request method (e.g. GET or POST). <code>BaseHTTPRequestHandler</code> provides a number of class and instance variables, and methods for use by subclasses.</dd>
<dd>The handler will parse the request and the headers, then call a method specific to the request type. The method name is constructed from the request. For example, for the request method <em>SPAM</em>, the <code>do_SPAM()</code> method will be called with no arguments. All of the relevant information is stored in instance variables of the handler. Subclasses should not need to override or extend the <code>__init__()</code> method.</dd>
<dt><strong><code class="highlight"><span class="k">class</span> <span class="nc">http</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">client_address</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code></strong></dt>
<dd>This class serves files from the current directory and below, directly mapping the directory structure to HTTP requests. A lot of the work, such as parsing the request, is done by the base class <code>BaseHTTPRequestHandler</code>. <mark>This class implements the <code>do_GET()</code> and <code>do_HEAD()</code> functions.</mark></dd>
<dt><strong><code class="highlight"><span class="k">class</span> <span class="nc">http</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">CGIHTTPRequestHandler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">client_address</span><span class="p">,</span> <span class="n">server</span><span class="p">)</span></code></strong></dt>
<dd>This class is used to serve either files or output of CGI scripts from the current directory and below. Note that mapping HTTP hierarchic structure to local directory structure is exactly as in <code>SimpleHTTPRequestHandler</code>.</dd>
<dd>The class will however, run the CGI script, instead of serving it as a file, if it guesses it to be a CGI script. Only directory-based CGI are used — the other common server configuration is to treat special extensions as denoting CGI scripts.</dd>
<dd>The <code>do_GET()</code> and <code>do_HEAD()</code> functions are modified to run CGI scripts and serve the output, instead of serving files, if the request leads to somewhere below the cgi_directories path.</dd>
</dl>
<p>Let's start with <code>SimpleHTTPRequestHandler</code> which has some implemented features.</p>
<h2 id="4-request-handler">4. Request Handler<a class="headerlink" href="#4-request-handler" title="Permanent link">⚓︎</a></h2>
<p>Based on <code>SimpleHTTPRequestHandler</code>, create a new class <code>StreamingHandler</code> and only override <code>do_GET()</code> method to just print requested <code>path</code> and then call the base method as it is already implemented.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">http.server</span> <span class="kn">import</span> <span class="n">SimpleHTTPRequestHandler</span>

<span class="k">class</span> <span class="nc">StreamingHandler</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="c1"># call to the base method implemented in SimpleHTTPRequestHandler</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">do_GET</span><span class="p">()</span>
</code></pre></div>
<p>The <code>SimpleHTTPRequestHandler</code> will serve files in <em>GET</em> requests, and it will looking for <code>index.html</code> for the homepage. </p>
<p>To display image, create an <code>&lt;img&gt;</code> tag which will request a file named <code>stream.mjpg</code>.</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Picamea MJPEG Live Stream<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
        <span class="c">&lt;!-- Request MJPEG stream --&gt;</span>
        <span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">"stream.mjpg"</span><span class="p">/&gt;</span>
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
<p><mark>There is no actual <code>stream.mjpg</code> file!</mark>.
When the web page request <code>stream.mjpg</code>, web serve should return a stream, not a single file, therefore a special sequence is needed to handle this special request of <code>stream.mjpg</code> file in the <code>do_GET()</code> method:</p>
<ol>
<li>Send response with HTTP Status Code 200 (Successful responses)<blockquote>
<p>read more at <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status">HTTP response status codes</a></p>
</blockquote>
</li>
<li>Send header with information to notify web client about type of responded content<blockquote>
<p>read more at <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Type">Content-Type</a></p>
</blockquote>
</li>
<li>Send the content in a stream format (loop forever!): send content type of each frame, then send the actual <code>frame</code>data</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">http.server</span> <span class="kn">import</span> <span class="n">SimpleHTTPRequestHandler</span>

<span class="k">class</span> <span class="nc">StreamingHandler</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s1">'/stream.mjpg'</span><span class="p">:</span>
            <span class="c1"># response</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
            <span class="c1"># header</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s1">'Age'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s1">'Cache-Control'</span><span class="p">,</span> <span class="s1">'no-cache, private'</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s1">'Pragma'</span><span class="p">,</span> <span class="s1">'no-cache'</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s1">'Content-Type'</span><span class="p">,</span> <span class="s1">'multipart/x-mixed-replace; boundary=FRAME'</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">frame</span> <span class="o">=</span> <span class="n">frame_buffer</span><span class="o">.</span><span class="n">frame</span> <span class="c1"># need frame_buffer as global</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">'--FRAME</span><span class="se">\r\n</span><span class="s1">'</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s1">'Content-Type'</span><span class="p">,</span> <span class="s1">'image/jpeg'</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s1">'Content-Length'</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">'</span><span class="se">\r\n</span><span class="s1">'</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">do_GET</span><span class="p">()</span>
</code></pre></div>
<p>Finally, wrap them up by creating instances of FrameBuffer, PiCamera, HTTPServer to start streaming:</p>
<div class="highlight"><pre><span></span><code><span class="n">frame_buffer</span> <span class="o">=</span> <span class="n">FrameBuffer</span><span class="p">()</span>

<span class="n">camera</span> <span class="o">=</span> <span class="n">PiCamera</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="s1">'640x480'</span><span class="p">,</span> <span class="n">framerate</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
<span class="n">camera</span><span class="o">.</span><span class="n">start_recording</span><span class="p">(</span><span class="n">frame_buffer</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">'mjpeg'</span><span class="p">)</span>

<span class="n">server_address</span> <span class="o">=</span> <span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="mi">8000</span><span class="p">)</span>
<span class="n">handler_class</span> <span class="o">=</span> <span class="n">StreamingHandler</span> <span class="c1"># alias</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">httpd</span> <span class="o">=</span> <span class="n">HTTPServer</span><span class="p">(</span><span class="n">server_address</span><span class="p">,</span> <span class="n">handler_class</span><span class="p">)</span>
    <span class="n">httpd</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">camera</span><span class="o">.</span><span class="n">stop_recording</span><span class="p">()</span>
</code></pre></div>
<div class="admonition bug">
<p class="admonition-title">Bug: Hangup stream</p>
<p>When run the above code, the web page shows up but with only one frame displayed, CPU is locked up at 100%, because the block <code class="highlight"><span class="k">while</span> <span class="kc">True</span><span class="p">:</span></code> loop causes the problem. </p>
<p><mark>Need to find a way to synchronize between camera thread and web server thread: send a frame only when it is availabe.</mark></p>
</div>
<h2 id="5-synchronize-between-threads">5. Synchronize between threads<a class="headerlink" href="#5-synchronize-between-threads" title="Permanent link">⚓︎</a></h2>
<p>Python has implemented a lock mechanism between threads:</p>
<dl>
<dt><strong><code class="highlight"><span class="k">class</span> <span class="nc">threading</span><span class="o">.</span><span class="n">Condition</span><span class="p">(</span><span class="n">lock</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code></strong></dt>
<dd>
<p>This class implements condition variable objects. A condition variable allows one or more threads to wait until they are notified by another thread. If the <code>lock</code> argument is given and not <code>None</code>, it must be a <code>Lock</code> or <code>RLock</code> object, and it is used as the underlying lock. Otherwise, a new <code>RLock</code> object is created and used as the underlying lock.</p>
<dl>
<dt><strong><code class="highlight"><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code></strong></dt>
<dd>Wait until notified or until a timeout occurs. If the calling thread has not acquired the <code>lock</code> when this method is called, a <code>RuntimeError</code> is raised.</dd>
<dd>This method releases the underlying <code>lock</code>, and then blocks until it is awakened by a <code>notify()</code> or <code>notify_all()</code> call for the same condition variable in another thread, or until the optional timeout occurs. Once awakened or timed out, it re-acquires the <code>lock</code> and returns.</dd>
</dl>
<p><div class="new-page"></div></p>
<dl>
<dt><strong><code class="highlight"><span class="n">notify_all</span><span class="p">()</span></code></strong></dt>
<dd>Wake up all threads waiting on this condition. This method acts like <code>notify()</code>, but wakes up all waiting threads instead of one. If the calling thread has not acquired the <code>lock</code> when this method is called, a <code>RuntimeError</code> is raised.</dd>
</dl>
</dd>
</dl>
<p>Then add a <code>Condition</code> object in <code>FrameBuffer</code>, and use it in <code>StreamingHandler</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Condition</span>

<span class="k">class</span> <span class="nc">FrameBuffer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="c1"># synchronize between threads</span>
<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">condition</span> <span class="o">=</span> <span class="n">Condition</span><span class="p">()</span>
</span>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">buf</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s1">'</span><span class="se">\xff\xd8</span><span class="s1">'</span><span class="p">):</span>
<span class="hll">            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="p">:</span>
</span>                <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">truncate</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
                <span class="c1"># notify other threads</span>
<span class="hll">                <span class="bp">self</span><span class="o">.</span><span class="n">condition</span><span class="o">.</span><span class="n">notify_all</span><span class="p">()</span>
</span>
<span class="k">class</span> <span class="nc">StreamingHandler</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s1">'/stream.mjpg'</span><span class="p">:</span>
            <span class="o">...</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="hll">                    <span class="k">with</span> <span class="n">frame_buffer</span><span class="o">.</span><span class="n">condition</span><span class="p">:</span>
</span>                        <span class="c1"># wait for a new frame</span>
<span class="hll">                        <span class="n">frame_buffer</span><span class="o">.</span><span class="n">condition</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</span>                        <span class="n">frame</span> <span class="o">=</span> <span class="n">frame_buffer</span><span class="o">.</span><span class="n">frame</span> <span class="c1"># access global variable, need to change later</span>
</code></pre></div>
<p>Wow, it works!!! The <mark>latency is just about 200ms</mark> which is unachievable with <a href="../stream_ffmpeg_hls_dash/">HLS/ MPEG-DASH</a></p>
<p><mark class="critic">
However, the CPU usage is quite high, Pi Zero W <em>only can handle 6 clients</em> at the same time with video quality at 640x480 @25fps.
</mark></p>
<p>
<figure><img src="stream_picamera_mjpeg.png"/><figcaption>A low latency in MJPEG streaming</figcaption>
</figure>
</p>
<h2 id="6-some-updates-in-the-script">6. Some updates in the script<a class="headerlink" href="#6-some-updates-in-the-script" title="Permanent link">⚓︎</a></h2>
<p>The instance <code>frame_buffer</code> is used as a global variable in the <code>StreamingHandler</code>, it is <em>not good</em> if there is another <code>FrameBuffer</code> used for another stream in a same script.</p>
<p>Here is an advanced method to have multiple frame buffers by passing an instance of <code>FrameBuffer</code> into an instance of <code>StreamingHandler</code>. It can be done by adding an <strong>Instance variable</strong> that holds reference to an instance of <code>FrameBuffer</code>, but can <em>not</em> be done using <strong>Class variable</strong>.</p>
<p>Let's check how they work.</p>
<h3 id="61-class-variable">6.1. Class variable<a class="headerlink" href="#61-class-variable" title="Permanent link">⚓︎</a></h3>
<p>Class variable is shared by all instance, therefore it acts like a global static attribute of the class.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">StreamingHandler</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    <span class="c1"># class variable refers to an instance of FrameBuffer</span>
    <span class="n">my_frame_buffer</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_frame_buffer</span><span class="o">.</span><span class="n">frame</span>

<span class="c1"># create an instance of FrameBuffer</span>
<span class="n">frame_buffer</span> <span class="o">=</span> <span class="n">FrameBuffer</span><span class="p">()</span>
<span class="n">handler_class</span> <span class="o">=</span> <span class="n">StreamingHandler</span> <span class="c1"># alias</span>

<span class="c1"># assign class variable</span>
<span class="n">handler_class</span><span class="o">.</span><span class="n">my_frame_buffer</span> <span class="o">=</span> <span class="n">frame_buffer</span>

<span class="c1"># all instance will share class variables</span>
<span class="n">first_handler</span> <span class="o">=</span> <span class="n">StreamingHandler</span><span class="p">()</span>
<span class="n">second_handler</span> <span class="o">=</span> <span class="n">StreamingHandler</span><span class="p">()</span>

<span class="c1"># first_handler.my_frame_buffer will be the same as second_handler.my_frame_buffer</span>
</code></pre></div>
<h3 id="62-instance-variable">6.2. Instance variable<a class="headerlink" href="#62-instance-variable" title="Permanent link">⚓︎</a></h3>
<p>Instance variables are for the data unique to each instance, they are create in the <code>__init()__</code> constructor of that class:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">StreamingHandler</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_buffer</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">client_address</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_frame_buffer</span> <span class="o">=</span> <span class="n">frame_buffer</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">client_address</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">():</span>
        <span class="o">...</span>
</code></pre></div>
<p>However, with this modification, script cannot use <code>StreamingHandler</code> to initialize <code>ThreadingHTTPServer</code> anymore, because it expects to call a request handler with only required positional arguments <code>(request, client_address, server)</code>, without a new argument <code>frame_buffer</code>.</p>
<p>Therefore, write a function that convert expected params list to new params list:</p>
<div class="highlight"><pre><span></span><code><span class="n">frame_buffer</span> <span class="o">=</span> <span class="n">FrameBuffer</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">getStreamingHandler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">client_address</span><span class="p">,</span> <span class="n">server</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">StreamingHandler</span><span class="p">(</span><span class="n">frame_buffer</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">client_address</span><span class="p">,</span> <span class="n">server</span><span class="p">)</span>

<span class="n">httpd</span> <span class="o">=</span> <span class="n">ThreadingHTTPServer</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">getStreamingHandler</span><span class="p">)</span>
</code></pre></div>
<p>Well, it works, but the convert function actually drop the param <code>directory</code> which is an optional param in original constructor of <code>SimpleHTTPRequestHandler</code>. To solve this problem, let's use special <code>*args</code> and <code>**kwargs</code>params.</p>
<h3 id="63-args-and-kwargs">6.3. <code>*args</code> and <code>**kwargs</code><a class="headerlink" href="#63-args-and-kwargs" title="Permanent link">⚓︎</a></h3>
<p>The special <code>*args</code> and <code>**kwargs</code> params allow to pass multiple arguments or keyword arguments to a function. Read about them in <a href="https://realpython.com/python-kwargs-and-args/">here</a>.</p>
<p>So, change the param list <code>(request, client_address, server, ...)</code> to <code>*args</code> in code, then it looks better:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">StreamingHandler</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_buffer</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_frame_buffer</span> <span class="o">=</span> <span class="n">frame_buffer</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

<span class="n">frame_buffer</span> <span class="o">=</span> <span class="n">FrameBuffer</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">getStreamingHandler</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">StreamingHandler</span><span class="p">(</span><span class="n">frame_buffer</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

<span class="n">httpd</span> <span class="o">=</span> <span class="n">ThreadingHTTPServer</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">getStreamingHandler</span><span class="p">)</span>
</code></pre></div>
<h3 id="64-lambda-function">6.4. Lambda function<a class="headerlink" href="#64-lambda-function" title="Permanent link">⚓︎</a></h3>
<p>Python and other languages like Java, C#, and even C++ have had lambda functions added to their syntax, whereas languages like LISP or the ML family of languages, Haskell, OCaml, and F#, use lambdas as a core concept. Read more in <a href="https://realpython.com/python-lambda/">here</a></p>
<p>So, reduce the function <code>getStreamingHandler</code> to a lambda function which can be declared in-line when creating <code>ThreadingHTTPServer</code> instance:</p>
<div class="highlight"><pre><span></span><code><span class="n">frame_buffer</span> <span class="o">=</span> <span class="n">FrameBuffer</span><span class="p">()</span>
<span class="n">httpd</span> <span class="o">=</span> <span class="n">ThreadingHTTPServer</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">StreamingHandler</span><span class="p">(</span><span class="n">frame_buffer</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">))</span>
</code></pre></div>
<h3 id="65-measure-fps">6.5. Measure FPS<a class="headerlink" href="#65-measure-fps" title="Permanent link">⚓︎</a></h3>
<p>In the while loop of sending frames, use <code>frame_count</code> variable to count the number of processed frames. With <code>time</code> package, it is easy to calculate FPS over a defined period, for example, 5 seconds in below code:</p>
<div class="highlight"><pre><span></span><code><span class="k">try</span><span class="p">:</span>
    <span class="c1"># tracking serving time</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">frame_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># endless stream</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">frames_buffer</span><span class="o">.</span><span class="n">condition</span><span class="p">:</span>
            <span class="c1"># wait for a new frame</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frames_buffer</span><span class="o">.</span><span class="n">condition</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="c1"># it's available, pick it up</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frames_buffer</span><span class="o">.</span><span class="n">frame</span>
            <span class="c1"># send it</span>
            <span class="o">...</span>
            <span class="c1"># count frames</span>
            <span class="n">frame_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># calculate FPS every 5s</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">"FPS: "</span><span class="p">,</span> <span class="n">frame_count</span> <span class="o">/</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
                <span class="n">frame_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="o">...</span>
</code></pre></div>
<p>Some lines of code to handle exception are also needed, for full source code, please download by clicking the below button.</p>
<!--
[:material-download: Download stream_picamera_mjpeg.zip](stream_picamera_mjpeg.zip){.md-button}
-->
<p><a class="md-button" href="https://github.com/vuquangtrong/pi_streaming"><span class="twemoji"><svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M5 20h14v-2H5m14-9h-4V3H9v6H5l7 7 7-7z"></path></svg></span> Download stream_picamera_mjpeg</a></p>
<h2 id="__comments">Comments</h2>
<div id="disqus_thread"></div>
<script>var disqus_config=function(){this.page.url="https://www.codeinsideout.com/blog/pi/stream_picamera_mjpeg/",this.page.identifier="blog/pi/stream_picamera_mjpeg/"};window.addEventListener("load",function(){var e=document,i=e.createElement("script");i.src="//vuquangtrong-github-io.disqus.com/embed.js",i.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(i)})</script>
</article>
</div>
</div>
<a class="md-top md-icon" data-md-component="top" data-md-state="hidden" href="#">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path></svg>
</a>
</main>
<footer class="md-footer">
<nav aria-label="Footer" class="md-footer__inner md-grid">
<a class="md-footer__link md-footer__link--prev" href="../stream_ffmpeg_hls_dash/" rel="prev">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</div>
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Previous
              </span>
              HLS/DASH Streaming
            </div>
</div>
</a>
<a class="md-footer__link md-footer__link--next" href="../stream_picamera_h264/" rel="next">
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Next
              </span>
              H264 streaming
            </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
<div class="md-footer-copyright__highlight">
            © 2021 Code Inside Out <div style="display:none"><div>
</div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
          Material for MkDocs
        </a>
</div>
<div style="color: var(--md-footer-fg-color--lighter);">
        using
        <a href="https://github.com/vuquangtrong/mkdocs-material-blog" rel="noopener" target="_blank">
            MkDocs Material Blog
        </a>
        theme
    </div>
</div>
</div>
<div class="md-footer-social">
<a class="md-footer-social__link" href="https://github.com/vuquangtrong" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 480 512" xmlns="http://www.w3.org/2000/svg"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"></path></svg>
</a>
<a class="md-footer-social__link" href="https://facebook.com/trongvq" rel="noopener" target="_blank" title="facebook.com">
<svg viewbox="0 0 320 512" xmlns="http://www.w3.org/2000/svg"><path d="m279.14 288 14.22-92.66h-88.91v-60.13c0-25.35 12.42-50.06 52.24-50.06h40.42V6.26S260.43 0 225.36 0c-73.22 0-121.08 44.38-121.08 124.72v70.62H22.89V288h81.39v224h100.17V288z"></path></svg>
</a>
<a class="md-footer-social__link" href="https://www.linkedin.com/in/vqtrong" rel="noopener" target="_blank" title="www.linkedin.com">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.top", "header.autohide"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../../assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
<script src="../../../assets/javascripts/bundle.4ea5477f.min.js"></script>
<script src="../../../assets/extra.js"></script>
<script src="https://unpkg.com/mermaid@8.8.0/dist/mermaid.min.js"></script><script>mermaid.initialize({});</script></body>
</html>